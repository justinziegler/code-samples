{% extends "./src/client/views/_layout_home.html" %}
{% import "./src/client/views/_css.html" as _css %}
{% import "./src/client/views/_js.html" as _js %}
{% import "./src/client/views/_modules.html" as _modules %}

{% block styles %}
  {{ _css.common() }}
  {{ _css.mattressAnimation() }}
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block meta %}
  <meta name="description" content="{{ description }}">
{% endblock %}

{% block content %}
  <section class="op-mattress-3d" data-current="1">
    <div class="container-fluid">
      <div class="row visible-xs visible-sm">
        <div class="heading col-xs-12">
          <h2>Four Premium Layers Bring Better Rest</h2>
          <h3>Four layers of premium foam work together to provide<br class="visible-sm"> 
            active cooling, comfort, and therapeutic support</h3>
        </div>
      </div>
      <div class="content row">
        
        <div class="layers col-xs-12 col-sm-6">
          <div class="frame" data-current="default">
            <div class="stage">
              {% for i in range(1, 6) %}
                <div class="layer lazyload" data-slide="{{ i }}" 
                  role="img" aria-label="Layer {{ i }}">
                  <div class="lazyload"></div><div class="lazyload"></div>
                </div>
              {% endfor %}
            </div>
            <div class="dots">
              {% for i in range(1, 5) %}
                {% set active = loop.index == 1 %}
                <button data-slide="{{ i }}" role="button" data-active="{{ active }}" aria-label="Layer {{ i }}" tabindex="0"><span></span></button>
              {% endfor %}
            </div>
          </div>
        
        <a class="photo-anchor"></a>
      </div>

      <div class="details col-xs-12 col-sm-6">
        <div class="row">
          <div class="heading col-xs-12 hidden-xs hidden-sm">
            <h2>Four Premium Layers<br> Bring Better Rest</h2>
            <h3>Four layers of premium foam work together to provide<br class="visible-sm"> 
              active cooling, comfort, and therapeutic support</h3>
          </div>
        </div>
        <div class="frame" data-current="1">
          <div class="stage">
            {% for layer in layers %}
              <div data-slide="{{ loop.index }}">
                <h4 data-slide="{{ loop.index }}">{{ layer.title }}</h4>
                <h3>{{ layer.details | safe }}</h3>
              </div>
            {% endfor %}            
          </div>
        </div>
      </div>
    </div>
  </section>

{% endblock %}

{% block scripts %}
{{ _js.swipeIt() }}
{{ _js.inViewport() }}
<script>
  // Slideshow
  const speed = .2;

  function nextSlide(slideshow) {
    var current = Number(slideshow.attr('data-current'));
    if (isNaN(current))  current = 1;
    var stage = slideshow.find('.stage');
    var max = stage.children().length;
    var next = current + 1;
    if (current < max) {
      slideshow.attr('data-current', next);
      slideshow.closest('section').attr('data-current', next);
      stage.attr('style', 'transition: ' + speed + 's ease-in-out;');
    } else { // at max
      next = 1;
      slideshow.attr('data-current', 1);
      slideshow.closest('section').attr('data-current', 1);
      var transition = ((max - 1) * speed);
      stage.attr('style', `transition: ${transition}s ease-in-out;`);
    }
    slideshow.find(`.stage div[data-slide="${next}"]`).attr('data-active', true).siblings().attr('data-active', false);
    if (slideshow.find('.dots').length) {
      slideshow.find(`.dots button[data-slide="${next}"]`).attr('data-active', true).siblings().attr('data-active', false);
      slideshow.find('.dots button').blur();
    }
  }

  function prevSlide(slideshow) {
    var current = Number(slideshow.attr('data-current'));
    if (isNaN(current)) current = 1;
    var stage = slideshow.find('.stage');
    if (current > 1) {
      var next = (current - 1);
      slideshow.attr('data-current', next);
      slideshow.closest('section').attr('data-current', next);
      stage.attr('style', `transition: ${speed}s ease-in-out;`);
      slideshow.find(`.stage div[data-slide="${next}"]`).attr('data-active', true).siblings().attr('data-active', false);
      if (slideshow.find('.dots').length) {
        slideshow.find(`.dots button[data-slide="${next}"]`).attr('data-active', true).siblings().attr('data-active', false);
        slideshow.find('.dots button').blur();
      }
    }
    return current;
  }

  function slideshowDots(dot) {
    dot.attr('data-active', true).siblings().attr('data-active', false);
    var current = Number(dot.closest('.frame').attr('data-current'));
    var slide = Number(dot.data('slide'));
    var transition = speed;
    if (current < slide) {
      transition = (speed * (slide - current));
    } else if (current > slide) {
      transition = (speed * (current - slide));
    }
    dot.closest('section').attr('data-current', slide);
    dot.closest('.frame').attr('data-current', slide).find('.stage').attr('style', `transition: ${transition}s ease-in-out`);
    dot.closest('.frame').find(`.stage div[data-slide="${slide}"]`).attr('data-active', true).siblings().attr('data-active', false);
  }

  var details = new SwipeIt('.op-mattress-3d .details .frame');
  var layersNav = $('.layers .dots button');
  $(layersNav).click(function(e) {
    slideshowDots($(this));
    var current = $(this).data('slide');
    $('.op-mattress-3d .details .frame').attr('data-current', current);
  });

  details.on('swipeLeft',function() {
    nextSlide($(this));
    var current = $(this).find('.stage div[data-active="true"]').attr('data-slide');
    $('.layers .frame').attr('data-current', current);
    $('.layer[data-slide="' + current + '"]').attr('data-active', true).siblings().attr('data-active', false);
    $('.layers .dots button[data-slide="' + current + '"]').attr('data-active', true).siblings().attr('data-active', false);
  })
  .on('swipeRight',function(e){
    prevSlide($(this));
    var current = $(this).find('.stage div[data-active="true"]').attr('data-slide');
    $('.layers .frame').attr('data-current', current);
    $('.layer[data-slide="' + current + '"]').attr('data-active', true).siblings().attr('data-active', false);
    $('.layers .dots button[data-slide="' + current + '"]').attr('data-active', true).siblings().attr('data-active', false);
  });

  var opAnimated = false;
  var opAnimation = (function() {
    $('.op-mattress-3d .photo-anchor').inViewport(function(px) {
      if (px && !opAnimated) {
        opAnimated = true;
        $('.op-mattress-3d .layer[data-slide="1"]').addClass("bounce1");
        $('.op-mattress-3d .layer[data-slide="2"]').addClass("bounce2");
        $('.op-mattress-3d .layer[data-slide="3"]').addClass("bounce3");
        $('.op-mattress-3d .layer[data-slide="4"]').addClass("bounce4");
        $('.op-mattress-3d .layer[data-slide="5"]').addClass("bounce5");
        $('.op-mattress-3d .layers .dots button').addClass("animate");
        setTimeout(function() {
          $('.op-mattress-3d .layer[data-slide="1"]').removeClass("bounce1").attr('style', 'opacity: 1;');
          $('.op-mattress-3d .layer[data-slide="2"]').removeClass("bounce2").attr('style', 'opacity: 1;');
          $('.op-mattress-3d .layer[data-slide="3"]').removeClass("bounce3").attr('style', 'opacity: 1;');
          $('.op-mattress-3d .layer[data-slide="4"]').removeClass("bounce4").attr('style', 'opacity: 1;');
          $('.op-mattress-3d .layer[data-slide="5"]').removeClass("bounce5").attr('style', 'opacity: 1;');
        }, 2500);
      }
    });  
  })
  opAnimation();
</script>
{% endblock %}