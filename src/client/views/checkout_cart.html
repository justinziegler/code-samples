{% extends "./src/client/views/_layout_home.html" %}
{% import "./src/client/views/_modules.html" as _modules %}
{% import "./src/client/views/_layout_cart_summary.html" as _cart_summary %}

{% block styles %}
{{ _css.cart() }}
{% endblock %}

{% block title %}Your Cart{% endblock %}

{% block meta %}
  <meta name="description" content="Your Shopping Cart">
{% endblock %}

{% block content %}
{# _m_js.cartExperiment() #}

<div class="container">
  <div class="row">

    {# Left column on tablet/desktop #}
    <div class="cart col-xs-12 col-sm-7 col-md-6">
      <div class="row">
        <div class="cart-summary col-xs-12">
          <div class="cart-head row">
            <div class="discount-message col-xs-12" style="display: none;">
              <p>Congratulations, You're <span class="alert">Saving <span class="discount"></span></span></p>
            </div>				 
            <div class="heading col-xs-12">
              <h2><span>Cart Summary</span></h2>
            </div>
          </div>
          <div class="row">
            <div class="col-xs-12">								
              <ul>
                {# Cart Items #}
                {%- for item in cart.items -%}
                  {%- set cartItem = true -%}
                  {%- set upsell = false -%}		
                  
                  {{- getCartItems(item, cartItem, upsell) -}}
                {%- endfor -%}

                {# Potential Upsells #}
                {%- for item in cart.upsells -%}
                  {%- set cartItem = false -%}
                  {%- set upsell = true -%}
                  {{- getCartItems(item, cartItem, upsell) -}}
                {%- endfor -%}


                {%- if mattress.length -%}										
                  {%- for item in mattress -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell) -}}
                  {%- endfor -%}
                {%- endif -%}
                
                {%- if luxeHybrid.length -%}										
                  {%- for item in luxeHybrid -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell) -}}
                  {%- endfor -%}
                {%- endif -%}

                {%- if originalPremium.length -%}										
                  {%- for item in originalPremium -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell) -}}
                  {%- endfor -%}
                {%- endif -%}

                {%- if protector.length -%}										
                  {%- for item in protector -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell) -}}
                  {%- endfor -%}
                {%- endif -%}

                {%- if pillow.length -%}										
                  {%- for item in pillow -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell) -}}
                  {%- endfor -%}
                {%- endif -%}
                
                {%- if metalFrame.length -%}										
                  {%- for item in metalFrame -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell) -}}
                  {%- endfor -%}
                {%- endif -%}
                
                {%- if woodFrame.length -%}										
                  {%- for item in woodFrame -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell) -}}
                  {%- endfor -%}
                {%- endif -%}
                
                {%- if cart.upsells.sheets.length -%}
                  {% set size = 'TW' %}
                  {% for u in sheets %}
                    {% set size = u.priorityProductSize %}
                  {% endfor %}
                  {%- for item in cart.upsells.sheets -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell, size) -}}
                  {%- endfor -%}
                {%- endif -%}

                {%- if duvet.length -%}										
                  {%- for item in duvet -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell) -}}
                  {%- endfor -%}
                {%- endif -%}

                {%- if foundation.length -%}										
                  {%- for item in foundation -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell) -}}
                  {%- endfor -%}
                {%- endif -%}

                {%- if foundationLegs.length -%}										
                  {%- for item in foundationLegs -%}
                    {%- set cartItem = false -%}
                    {%- set upsell = true -%}
                    {{- getCartItems(item, cartItem, upsell) -}}
                  {%- endfor -%}
                {%- endif -%}
              </ul>
              <div class="removed-items">
                {% for item in cart.items %}
                  {%- set type = item.sku.slice(3, -6) -%}
                  <p data-sku="{{ item.sku }}" style="display: none;">
                    <span>{{ item.name }}</span> was removed. 
                    <a class="cancel-remove" data-sku="{{ item.sku }}" title="Cancel" role="button" tabindex="0">Undo</a>
                  </p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>					

        <div class="upsells col-xs-12">
          <h2><span>Frequently Bought Together</span></h2>
          {# This is for determining the base size used in upsells and applying some 
              title trickery to products that cover two sizes, like the duvets #}
          {%- set upsellSize = '' -%}
          {%- if mattress.length -%}
            {%- for u in mattress -%}
              {%- set upsellSize = u.sku.slice(9, limit) -%}
            {%- endfor -%}
          {%- elif luxeHybrid.length -%}
            {%- for u in luxeHybrid -%}
              {%- set upsellSize = u.sku.slice(9, limit) -%}
            {%- endfor -%}
          {%- elif protector.length -%}
            {%- for u in protector -%}
              {%- set upsellSize = u.sku.slice(9, limit) -%}
            {%- endfor -%}
          {%- elif metalFrame.length -%}
            {%- for u in metalFrame -%}
              {%- set upsellSize = u.sku.slice(9, limit) -%}
            {%- endfor -%}
          {%- elif woodFrame.length -%}
            {%- for u in woodFrame -%}
              {%- set upsellSize = u.sku.slice(9, limit) -%}
            {%- endfor -%}
          {%- elif sheets.length -%}
            {%- for u in sheets -%}
              {%- set upsellSize = u.sku.slice(9, limit) -%}
            {%- endfor -%}
          {%- elif foundation.length -%}
            {%- for u in foundation -%}
              {%- set upsellSize = u.sku.slice(9, limit) -%}
            {%- endfor -%}
          {%- elif foundationLegs.length -%}
            {%- for u in foundationLegs -%}
              {%- set upsellSize = u.sku.slice(9, limit) -%}
            {%- endfor -%}
          {%- endif -%}

          <ul>
            {{- getUpsells() -}}
          </ul>
        </div>
      </div>
    </div>

    {# Right column in tablet/desktop #}
    <div class="order-summary col-xs-12 col-sm-5 col-md-offset-1">
      <div class="row">
        <div class="col-xs-12 col-md-10 col-md-offset-2">
          <div class="row">
            <div class="summary col-xs-12">
              <div class="col-xs-12">
                <h6 class="my-order">My Order</h6>
              </div>
              <div class="options row">
                <div class="summary-total col-xs-6">
                  <h5>Subtotal</h5>
                  <h6 class="total js-subtotal-output"></h6>
                </div>
                <div class="summary-monthly-payment col-xs-6">
                  <h5>As Low As</h5>
                  <h6 class="monthly-payment"></h6>
                  <p class="small">
                    Choose Affirm at Checkout<br>
                    APR as low as 0%<br>
                    <a data-toggle="modal" data-target="#financing-modal" role="button" tabindex="0" href="">Learn More</a>
                  </p>
                </div>
              </div>

              <div class="row">
                <div class="checkout col-xs-12">
                  <p class="delivery">Free Shipping, No-Contact Delivery</p>
                  <a href="checkout/address" class="btn btn-checkout"><span></span>Checkout</a>
                </div>
              </div>

              <h4 class="continue"><a href="shop">Continue Shopping </a></h4>
            </div>
            
          </div>

          <div class="apple-pay-wrapper col-xs-12" style="display: none;">
            <h4><span>Or express checkout</span></h4>
            <div class="apple-pay-button apple-pay-button-black">
              Pay with <span></span>
            </div>
          </div>
          
          <div class="row">
            <div class="callouts col-xs-12">
              <div class="row">
                <div class="callout col-xs-12">
                  <div class="row">
                    <div class="badge warranty col-xs-4" role="img" aria-label="Image: Lifetime Warranty"></div>
                    <div class="tagline col-xs-8">
                      <h4>Lifetime Warranty</h4>
                      <p>Guaranteed restful sleep</p>
                    </div>
                  </div>
                </div>
                
                <div class="callout col-xs-12">
                  <div class="row">
                    <div class="badge trial col-xs-4" role="img" aria-label="Image: 365 Night Trial"></div>
                    <div class="tagline col-xs-8">
                      <h4>365 Night Stress-Free Trial</h4>
                      <p>Hassle-Free Returns</p>
                    </div>
                  </div>
                </div>

                <div class="callout col-xs-12">
                  <div class="row">
                    <div class="badge recommended col-xs-4" role="img" aria-label="Image: Best Buy and Recommended"></div>
                    <div class="tagline col-xs-8">
                      <h4>Independently Rated</h4>
                      <p>BEST BUY and RECOMMENDED</p>
                    </div>
                  </div>
                </div>

              </div>	
            </div>

            <div class="copyright col-xs-12">
              <p>&copy; {{ currentYear }} Lull</p>
            </div> 
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# Upsell modals #}
{% if mattress.length %}										
  {{ getUpsellModals(mattress) }}
{% endif %}

{% if luxeHybrid.length %}										
  {{ getUpsellModals(luxeHybrid) }}
{% endif %}

{% if protector.length %}										
  {{ getUpsellModals(protector) }}
{% endif %}

{% if pillow.length %}										
  {{ getUpsellModals(pillow) }}
{% endif %}

{% if sheets.length %}										
  {{ getUpsellModals(sheets) }}
{% endif %}

{% if duvet.length %}										
  {{ getUpsellModals(duvet) }}
{% endif %}

{% if woodFrame.length %}										
  {{ getUpsellModals(woodFrame) }}
{% endif %}

{% if metalFrame.length %}										
  {{ getUpsellModals(metalFrame) }}
{% endif %}

{% if foundation.length %}										
  {{ getUpsellModals(foundation) }}
{% endif %}

{% if foundationLegs.length %}										
  {{ getUpsellModals(foundationLegs) }}
{% endif %}

{# Financing Modal #}
<div  role="dialog" aria-modal="true" class="modal fade content-modal" id="financing-modal" tabindex="-1" aria-labelledby="financing">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">		
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"></span></button>			
        <h2>Easy Monthly Payments <span class="hidden-xxs">Available</span></h2>	
        <h3>As low as 0% APR Financing Available with Affirm</h3>
        <h3>
          $<span class="monthly-payment"></span>/mo. based on a purchase price of 
          $<span class="total"></span> at 0% APR for <span class="term" data-term="18"></span> months. <br class="visible-md visible-lg">
          A down payment may be required.
        </h3>		
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="icon-calendar"></div>
            <p><strong>Easy Monthly Payments</strong><br>
              Provide your basic information. Get instantly approved. Pay over 6 to 
              <span class="term" data-term="18"></span> months with as low as 0% APR for qualified applicants.					
            </p>
          </div>
          <div class="col-md-6">
            <div class="icon-payment"></div>
            <p><strong>Flexible Payments</strong><br>		
            Easily pay your monthly bill using a bank transfer check, or debit card at <a href="http://affirm.com" target="_blank">affirm.com</a>.</p>
          </div>
          <div class="clearfix"></div>
          <h3>Select <strong>'Affirm Monthly Payments'</strong><br class="visible-xxs"> at Checkout</h3>
          <a href="/finance" class="btn-primary btn">Tell Me More</a>
        </div>
        <div class="qualified">
          <p>0% APR financing over 6, 12<span class="term" data-term="18"></span> months available to qualified applicants.</p>
        </div>
      </div>
      <div class="modal-footer">
        <div class="row">
          <div class="col-md-12">
            <p>
              Rates from 0-30% APR. Subject to credit check and approval.<br class="visible-sm"> Estimated payment amount excludes taxes and shipping fees.<br class="visible-md visible-lg"> Payment options through Affirm are provided by these lending partners: affirm.com/lenders. See <a href="http://www.affirm.com/faqs" target="_blank">www.affirm.com/faqs</a> for details.</p> 
          </div>
        </div>
      </div> 
    </div>
  </div>
</div>

<div class="desktop-backdrop"></div>
{% endblock %}

{% block scripts %}
<script>

function updateCart() {
  var cart = [];
  var totalQty = 0;
  $('.cart-summary li[data-cart-item="true"] .item[data-active="true"]').each(function() {
    var sku = $(this).data('sku');
    var qty = $(this).attr('data-quantity'); 
    {# this is retrieved differently because it may have changed #}
    totalQty += parseInt(qty);
    cart.push({ 'sku': sku, 'quantity': qty });

    if ($(this).attr('data-add-on-available') === 'true') {
      var addOn = $(this).closest('li').find('.addon');
      var aActive = addOn.attr('data-active') === 'true';
      if (aActive) {
        var aSku = addOn.data('sku');
        var aQty = addOn.attr('data-quantity');
        totalQty += parseInt(aQty);
        cart.push({ 'sku': aSku, 'quantity': aQty });
      }
    }
  });
  $('nav .cart-total').text(totalQty);
  var upsellCount = $('.upsells > ul > li[data-active="false"]').length;
  if (upsellCount == 0) {
    $('.upsells').addClass('hidden');
    upsellsHidden = true;
  }

  // $('body').addClass('processing');
  // {# Temporarily prevent pointer events #}
  // $.ajax("/api/updatecart", {
  //   contentType: "application/x-www-form-urlencoded",
  //   data: { cart: cart },
  //   type: "POST",
  //   success: function(result, status, xhr) {
  //     if (result.ok !== true) {
  //       console.log("FAIL updateCart: " + result.debug);
  //       if (window.Rollbar && window.Rollbar.error) {
  //         Rollbar.error('updatecart failed', result);
  //       }
  //       displayErrorBox(result.message);
  //     }
  //     {# push update_cart event #}
  //     pushToDataLayer({
  //       'event': 'update_cart',
  //       'updated_cart': result.cart
  //     });
  //     $('body').removeClass('processing');
  //   },
  //   error: function(xhr, status, error) {
  //     if (window.Rollbar && window.Rollbar.error) {
  //       Rollbar.error('updatecart XHR failed', error);
  //     }
  //     displayGenericError();
  //   }
  // });
};

{# Upsells + Addons #}
function addToCart(sku) {
  // $('body').addClass('processing');

  // pushToDataLayer({
  //   'event': 'add_to_cart',
  //   'added_sku': sku.toUpperCase(),
  //   'eventCallback': function (containerId) {
  //     if (containerId === '{{state.config.GTM_CONTAINER}}') {
  //       $.ajax("/api/addCartItem", {
  //         contentType: "application/x-www-form-urlencoded",
  //         data: { sku: sku },
  //         type: "POST",
  //         success: function(result, status, xhr) {
  //           if (result.ok !== true) {
  //             console.log("FAIL addCartItem: " + result.debug);
  //             if (window.Rollbar && window.Rollbar.error) {
  //               Rollbar.error('addToCart failed', result);
  //             }
  //             displayErrorBox(result.message);
  //           } 
  //           $('body').removeClass('processing');
  //         },
  //         error: function(xhr, status, error) {
  //           if (window.Rollbar && window.Rollbar.error) {
  //             Rollbar.error('addToCart XHR failed', error);
  //           }
  //           displayGenericError();
  //         }
  //       });
  //     }
  //   },
  //   'eventTimeout': 2000
  // });
}

function numberWithCommas(x) {
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

var animationDuration = 300; {# used in calculation and removal functions #}
var upsellsHidden = false;
var total, subtotal, cartDiscount;

function calculate() {
  total = cartDiscount = 0;
  var item = $('.cart-summary li[data-cart-item="true"] .item[data-active="true"]');
  item.each(function() {
    var qty = $(this).attr('data-quantity');
    {# Retrieving qty slightly differently because it may be changed #}
    var unitPrice = $(this).data('price');
    var itemPrice = (unitPrice * qty);
    total += itemPrice;
    var discount = ($(this).data('discount') * qty);
    cartDiscount += discount;

    if ($(this).attr('data-add-on-available') === 'true') {
      var addOn = $(this).closest('li').find('.addon');
      var aActive = addOn.attr('data-active') === 'true';
      if (aActive) {
        var aQty = addOn.attr('data-quantity');
        var aUnitPrice = addOn.data('price');
        var aItemPrice = (aUnitPrice * aQty);
        total += aItemPrice;
      }
    }
  });

  var term = 18;
  if (total >= 799) {
    term = 24;
  }
  var monthlyPayment = total / term;

  subtotal = total + cartDiscount;
  var s = numberWithCommas(subtotal.toFixed(2));
  $('.subtotal').text(s);
  var t = numberWithCommas(total.toFixed(2));
  $('.total').text(t);
  var mp = numberWithCommas(monthlyPayment.toFixed(2));
  $('.monthly-payment').text(mp);
  $('.term').attr('data-term', term);
  
  $('.order-summary .discount').text('$' + numberWithCommas(cartDiscount.toFixed(2)));
  if (Number.isInteger(cartDiscount)) {
    $('.discount-message .discount').text('$' + numberWithCommas(cartDiscount));
  } else {
    $('.discount-message .discount').text('$' + numberWithCommas(cartDiscount.toFixed(2)));
  }


  if (cartDiscount > 0) {
    $('.discount-message, .discounts.line-item').slideDown(animationDuration);
  } else {
    $('.discount-message, .discounts.line-item').slideUp(animationDuration);
  }

  var upsellItems = $('.upsells li[data-active="false"').length;
  if (upsellItems == 0) {
    $('.upsells').addClass('hidden');
    upsellsHidden = true;
  } else {
    $('.upsells').removeClass('hidden');
    upsellsHidden = false;
  }
  $('.subtotal, .total, .monthly-payment, .discount').removeClass('blur');
}

function checkAddOnQuantity(item) {
  var qty = item.attr('data-quantity');
  var addOnAvailable = item.attr('data-add-on-available') === 'true';
  if (addOnAvailable) {
    var addOn = item.closest('li').find('.addon');
    var aActive = addOn.attr('data-active') === 'true';
    var aQty = addOn.attr('data-quantity');
    if (aActive) {
      if (parseInt(aQty) > parseInt(qty)) {
        addOn.find('.qty.plus').addClass('disabled');
        addOn.attr('data-quantity', qty);
        addOn.find('.qty-display').attr('data-quantity', qty);
        if (qty == 1) {
          addOn.find('.qty.minus').addClass('disabled');
        }
      } else if (aQty == qty) {
        addOn.find('.qty.plus').addClass('disabled');
      } else {
        addOn.find('.qty.plus').removeClass('disabled');
      }
    } 
  }
}

$("nav").autoHidingNavbar();
  
$(document).ready(function() {
  calculate();

  {# Set flexbox order for existing cart + upsell items at load #}
  {# The count for each only ever increases - purely a visual tool #}
  var cartCount = 0;
  $('.cart-summary li[data-cart-item="true"]').each(function() {
    cartCount++;
    $(this).css('order', cartCount);
  });

  var upsellCount = 0;
  $('.upsells > ul > li').each(function() {
    upsellCount++;
    $(this).css('order', upsellCount);
  });

  function update() {	 
    $('.subtotal, .total, .monthly-payment, .discount').addClass('blur');
    $('body').addClass('processing');
    setTimeout(function() {
      calculate();
      updateCart();
      $('body').removeClass('processing');
    }, animationDuration + 100); // after animation ends
  }

  function resetAddOn(item) {
    var addOnAvailable = item.find('.item').attr('data-add-on-available') === 'true';
    if (addOnAvailable) {
      item.find('.addon .qty-display').attr('data-quantity', 1); 
      item.find('.addon').attr('data-active', false).attr('data-quantity', 0).slideUp(animationDuration);
    }
  }

  {# Quantity spinners #}
  $('.product .quantity input').on('propertychange input paste spin change', function() {
    var qty = $(this).val();
    var item = $(this).closest('li').find('.item');
    if (qty >= 1) {
      item.attr('data-quantity', qty);
    }
    if (qty == 1) {
      $(this).parent().find('.qty.minus').addClass('disabled');
    }
    checkAddOnQuantity(item);
    update();
  });

  $('.product .qty').on('keypress click', function(e) {
    if (e.which === 13 || e.type === 'click') {
      var item = $(this).closest('li').find('.item');
      var qty = item.attr('data-quantity');
      if ($(this).hasClass('minus')) {
        if (qty > 1) {
          qty--;
        }
      } else if ($(this).hasClass('plus')) {
        qty++;
      }
      item.attr('data-quantity', qty);
      $(this).parent().find('.qty-display').attr('data-quantity', qty);
      if (qty == 1) {
        $(this).parent().find('.qty.minus').addClass('disabled');
      } else if (qty > 1) {
        $(this).parent().find('.qty.minus').removeClass('disabled');
      }
      checkAddOnQuantity(item);
      update();
    }
  });

  $('.addon .qty').on('keypress click', function(e) {
    if (e.which === 13 || e.type === 'click') {
      var addon = $(this).closest('.addon');
      var qty = addon.attr('data-quantity');
      var itemQty = $(this).closest('li').find('.item').attr('data-quantity');
      if ($(this).hasClass('minus')) {
        if (qty > 1) {
          qty--;
        }
      } else if ($(this).hasClass('plus')) {
        if (parseInt(qty) < parseInt(itemQty)) {
          qty++;
        }
      }
      addon.attr('data-quantity', qty);
      $(this).parent().find('.qty-display').attr('data-quantity', qty);
      if (parseInt(qty) == parseInt(itemQty)) {
        $(this).parent().find('.qty.plus').addClass('disabled');
      }
      if (parseInt(qty) < parseInt(itemQty)) {
        $(this).parent().find('.qty.plus').removeClass('disabled');
      }
      if (qty == 1) {
        $(this).parent().find('.qty.minus').addClass('disabled');
      } else if (qty > 1) {
        $(this).parent().find('.qty.minus').removeClass('disabled');
      }
      update();
    }
  });

  {# Remove product #}
  $('.product .remove').on('keypress click', function(e) {
    if (e.which === 13 || e.type === 'click') {
      var item = $(this).closest('li');
      var sku = item.data('sku');
      var upsell = item.attr('data-upsell') === 'true';
      {# Checking whether the cart item came from the upsell section #}
      if (upsell) {
        var type = item.find('.item[data-active="true"]').data('type');
        if (type == 'CS' || type == 'OC') {
          type = 'CB';
        }
        var color = item.find('.item[data-active="true"]').data('color');
        var upsellItem = $('.upsells > ul > li[data-type="' + type + '"]');

        if (upsellsHidden) {
          $('.upsells').removeClass('hidden');
          upsellsHidden = false;
        }

        item.slideUp(animationDuration);
        {# The two lines below send removed upsells to the bottom of the list.
            Works fine, but might confuse users #}
        upsellCount++;
        upsellItem.css('order', upsellCount); 
        upsellItem.find('> div').css('opacity', 0);
        upsellItem.slideDown(animationDuration);
        $(document).trigger('cart', [ 'remove', sku ]);
        
        $('body').addClass('processing');
        setTimeout(function() {
          item.attr('data-cart-item', false);
          item.find('.current-size, .item').attr('data-active', false);
          upsellItem.attr('data-active', false);
          upsellItem.find('> div').css('opacity', 1);
          resetAddOn(item);
          $('body').removeClass('processing');
        }, (animationDuration));

      } else {	
        {# item is not an upsell #}
        item.children().css('opacity', 0);
        $('body').addClass('processing');
        setTimeout(function() {
          item.slideUp(animationDuration);
          $('.removed-items p[data-sku="' + sku + '"]').slideDown(animationDuration);
          item.attr('data-cart-item', false);
          resetAddOn(item);
          $('body').removeClass('processing');
        }, animationDuration);
      }
      update();
    }
  });		

  $('.cancel-remove').on('keypress click', function(e) {
    if (e.which === 13 || e.type === 'click') {
      var sku = $(this).data('sku');
      var item = $('.cart-summary li[data-sku="' + sku + '"]');
      cartCount++;
      item.attr('data-cart-item', true).css('order', cartCount);
      $(document).trigger('cart', [ 'add', sku ]);

      $(this).parent().slideUp(animationDuration);
      item.slideDown(animationDuration);
      setTimeout(function() {
        item.children().css('opacity', 1);
      }, animationDuration);
      var addOnAvailable = item.find('.item').attr('data-add-on-available') === 'true';
      if (addOnAvailable) {
        var aSku = item.find('.addon').data('sku');
        if ($('.upsells li[data-sku="' + aSku + '"]').length) {
          upsellCount++;
          var addOnItem = $('.upsells li[data-sku="' + aSku + '"]');
          addOnItem.css('order', upsellCount).attr('data-active', false); 
          addOnItem.find('> div').css('opacity', 0);
          addOnItem.slideDown(animationDuration);
          setTimeout(function() {
            addOnItem.find('> div').css('opacity', 1);
          }, (animationDuration));
        }
      }
      update();
    }
  });

  {# Upsell buttons #}
  $('.upsells li[data-add-on="false"] .add-to-cart .btn').on('keypress click', function(e) {
    if (e.which === 13 || e.type === 'click') {
      var item = $(this).closest('li');

      var type = item.find('.item[data-active="true"]').data('type');
      var sku = item.find('.item[data-active="true"]').data('sku');
      var color = item.find('.item[data-active="true"]').attr('data-color');
      {# Retrieving color slightly differently because it may be changed #}
      var cartItem = $('.cart-summary li[data-type="' + type + '"][data-color="' + color + '"][data-upsell="true"]');
      cartCount++;

      {# Prepare cart item to animate in #}
      cartItem.children().css('opacity', 0);
      cartItem.attr('data-color', color);
      cartItem.css('order', cartCount).attr('data-cart-item', true);

      {# Add to Cart animation #}
      item.attr('data-active', true).slideUp(animationDuration);
      cartItem.slideDown(animationDuration);
      setTimeout(function() {
        cartItem.children().css({'opacity': 1 });
      }, (animationDuration));

      cartItem.find('.item[data-sku="' + sku + '"], .current-size[data-sku="' + sku + '"]').attr('data-active', true);
      addToCart(sku);
      $(document).trigger('cart', [ 'add', sku ]);
      update();
    }
  });

  $('.upsells .dropdown li[data-out-of-stock="false"]').on('keypress click', function(e) {
    if (e.which === 13 || e.type === 'click') {
      var sku = $(this).data('sku');
      var item = $(this).parent().closest('.product-details');
      item.attr('data-type', sku.slice(3, -6));
      item.find('.pricing div, .current-size, .upsell-item').attr('data-active', false);
      item.find('.item[data-sku="' + sku + '"], .current-size[data-sku="' + sku + '"], .upsell-item[data-sku="' + sku + '"]')
        .attr('data-active', true);
    }
  });

  $('.upsells .dropdown li.color-select').on('keypress click', function(e) {
    if (e.which === 13 || e.type === 'click') {
      e.stopPropagation();
      {# prevent menu from closing if the container is clicked #}
    }
  });

  $('.upsells .dropdown li.color-select li').on('keypress click', function(e) {
    if (e.which === 13 || e.type === 'click') {
      e.stopPropagation();
      var color = $(this).data('color');
      var colorName = $(this).data('color-name');
      var item = $(this).parent().closest('.product-details');
      $(this).attr('data-active', true).siblings().attr('data-active', false);
      var type = item.find('li.upsell-item[data-active="true"]').data('type');
      item.find('li.upsell-item').hide().attr('data-active', false);
      var sku = item.find('li.upsell-item[data-type="' + type + '"][data-color="' + color + '"]').data('sku');
      item.find('.pricing div, .current-size, .upsell-item').attr('data-active', false);
      item.find('.item[data-sku="' + sku + '"], .current-size[data-sku="' + sku + '"], .upsell-item[data-sku="' + sku + '"]')
        .attr('data-active', true);
      item.find('li.upsell-item[data-color="' + color + '"]').show();
      item.find('.color-label').attr('data-active-color-name', colorName);
      item.find('.current-size').attr('data-active-color', color);
      item.closest('li').attr('data-color', color);
    }
  });

  {# Add-ons, like Clyde #}
  $('.upsells li[data-add-on="true"] .add-to-cart .btn').on('keypress click', function(e) {
    if (e.which === 13 || e.type === 'click') {
      var item = $(this).closest('li');
      var sku = item.data('sku');
      var parentSku = item.data('parent-sku');
      var cartItem = $('.cart-summary li[data-sku="' + parentSku + '"] .addon[data-sku="' + sku + '"]');
      cartCount++;

      {# Prepare cart item to animate in #}
      cartItem.children().css('opacity', 0);
      cartItem.attr('data-active', true).attr('data-quantity', 1);
      var x = cartItem.closest('li').find('.item');
      checkAddOnQuantity(x);

      {# Add to Cart animation #}
      item.attr('data-active', true).slideUp(animationDuration);
      cartItem.slideDown(animationDuration);
      setTimeout(function() {
        cartItem.children().css({'opacity': 1 });
      }, (animationDuration));

      addToCart(sku);
      update();
    }
  });

  $('.addon .remove').on('keypress click', function(e) {
    if (e.which === 13 || e.type === 'click') {
      var item = $(this).closest('.addon');
      var parentItem = $(this).closest('li');
      item.children().css('opacity', 0);
      var sku = item.data('sku');
      $('body').addClass('processing');
      upsellCount++;
      setTimeout(function() {
        item.slideUp(animationDuration).attr('data-active', false).attr('data-quantity', 0);
        item.find('.qty-display').attr('data-quantity', 1);
        $('.upsells li[data-sku="' + sku + '"]').css('order', upsellCount).slideDown(animationDuration);
        $('body').removeClass('processing');
      }, animationDuration);
      update();
    }
  });
});

$(document).on('cart', function(event, type, sku) {
  {# Keep track of which cart items are upsells in case of cart refresh #}
  var upsells = new Set();
  if ('cart_upsells' in localStorage) {
    var cart_upsells = JSON.parse(localStorage.getItem('cart_upsells'));
    upsells = new Set(cart_upsells);
    localStorage.removeItem('cart_upsells');
  }
  if (type === 'add') {
    upsells.add(sku);
  } else if (type === 'remove') {
    upsells = upsells.delete(sku);
  } else {
    throw new Error('Invalid cart subtype');
  }
  var upsells_array = Array.from(upsells);
  localStorage.setItem('cart_upsells', JSON.stringify(upsells_array));
});

$('a.btn-checkout').on('keypress click', function(event) {
  if (event.which === 13 || event.type === 'click') {
    var cartItems = []; 
    var upsells = [];
    var refreshedUpsells = [];
    var checkoutButton = this;
    var upsellStats = {
      total: 0,
      quantity: 0
    };
    if ('cart_upsells' in localStorage) {
      {# Upsells added to cart before a page refresh #}
      refreshedUpsells = JSON.parse(localStorage.getItem('cart_upsells'));
      localStorage.removeItem('cart_upsells');
    }
    var cartItem = $('.cart-summary li[data-cart-item="true"]');
    cartItem.each(function() {
      var sku = $(this).data('sku');
      cartItems.push(sku);
      
      var upsell = $(this).attr('data-upsell') === 'true';
      if (cartItems.some(sku => refreshedUpsells.includes(sku))) {
        upsell = true;
      }
      if (upsell) {
        upsells.push(sku);
        var qty = parseInt($(this).find('.item[data-sku="' + sku + '"]').attr('data-quantity'));
        var price = $(this).find('.item[data-sku="' + sku + '"]').data('price');
        upsellStats.quantity += qty;
        upsellStats.total += (price * qty);
      }
      if ($(this).find('.addon').length) {
        if ($(this).find('.addon').attr('data-active') === 'true') {
          var addonSku = $(this).find('.addon').data('sku');
          cartItems.push(addonSku);
        }
      }
    });

    var gtmEvent = {
      event: 'custom_event',
      eventCategory: 'upsell',
      eventCallback: function (containerId) {
        if (containerId === '{{state.config.GTM_CONTAINER}}') {
          var url = $(checkoutButton).attr('href');
          window.location.href = url;
        }
      },
      eventTimeout: 2000,
      eventAction: 'button-click',
      eventLabel: 'cart-page-checkout',
      eventName: 'Cart - Click - Checkout - Custom',
      eventData: {
        'Cart Total': total,
        'Subtotal': subtotal,
        'Products': cartItems, 
        'Upsell Total': upsellStats.total,
        'Upsell Products': upsells,
        'Upsell Quantity': upsellStats.quantity
      }
    };
    pushToDataLayer(gtmEvent);
    return false;
  }
})

{# Clyde modal #}
$('a[data-gsc-modal="true"]').on('keypress click', function(e) {
  if (e.which === 13 || e.type === 'click') {
    var id = $(this).data('gsc-modal-id');
    gsc('show', id);
  }
});

{# Upsell modal galleries - create and destroy when needed #}
$('.upsell-modal').on('shown.bs.modal', function () {
  var upsellId = $(this).attr('id');
  var gallery = new Swiper ('#' + upsellId + ' .gallery', {
    loop: true,
    grabCursor: true,
    breakpointsInverse: true,
    centeredSlides: true,
    pagination: {
    el: '#' + upsellId + ' .gallery .swiper-pagination',
      clickable: true,
    },
  });
  var specs = new Swiper ('#' + upsellId + ' .technicalities', {
    loop: true,
    grabCursor: true,
    breakpointsInverse: true,
    centeredSlides: true,
    pagination: {
    el: '#' + upsellId + ' .technicalities .swiper-pagination',
      clickable: true,
    },
  });
});
$('.upsell-modal').on('hidden.bs.modal', function () {
  var upsellId = $(this).attr('id');
  var gallery = document.querySelector('#' + upsellId + ' .gallery').swiper;
  gallery.destroy();
  var specs = document.querySelector('#' + upsellId + ' .technicalities').swiper;
  specs.destroy();
});
</script>
{% endblock %}

{# Macros #}
{% macro checkTitleLength(type) -%}
  {%- switch type -%}
    {%- case 'PW' -%}
      true
    {%- case 'FO' -%}
      true
    {%- case 'FL' -%}
      true
    {%- case 'SH' -%}
      true
    {%- case 'TU' -%}
      true
    {%- case 'UU' -%}
      true
    {%- case 'PM' -%}
      true
    {%- case '6449SD10E' -%}
      true
    {%- default -%}
      false
  {%- endswitch -%}
{%- endmacro -%}

{%- macro getCartItems(item, cartItem, upsell, size) -%}
{# Retrieves cart items and potential upsells #}
{# 'item' refers to cart items. 'cartItem' and 'upsell' are booleans #}
  {% set addOnItem, addOnAvailable = false %}
  {% if item.sku.charAt(0) == 6 %}
    {# product is a protection plan #}
    {% set addOnItem = true %}
  {% endif %}

  {%- set productCategories = [ 28, 1 ] -%}
  {%- for category in productCategories -%}
    {%- if item.productCategoryId == category -%}
      {%- set addOnAvailable = true -%}
    {% endif %}
  {% endfor %}

  {% set itemOk = true %}
  {%- if upsell and item.description !== undefined %}
    {# This is to filter out extra upsell sizes for sheets, etc. #}
    {% if item.sku.slice(9, limit) !== size %}
      {% set itemOk = false %}
    {% endif %}
  {% endif %}

  {% if itemOk and not addOnItem %}
  <li data-sku="{{ item.sku }}"
      data-type="{{ item.type }}"
      data-color="{{ item.color }}"
      data-cart-item="{{ cartItem }}"
      data-upsell="{{ upsell }}"			
      {% if upsell %}style="display: none;"{% endif %}>
    <div class="product row">
      <div class="product-image col-xs-3">
        <div class="lazyload" role="img" aria-label="Image: {{ item.name }}">
        </div>
      </div>
      <div class="product-details col-xs-9">
        <div class="row">
          <div class="details col-xs-9">
            {%- if upsell -%}
              {% if item.description !== undefined %} {# Pulling upsells directly from cart upsells #}
                <h3 class="current-size" data-sku="{{ item.sku }}" data-active="false">
                  {{- item.name }}
                </h3>
                <h4 class="current-size" data-sku="{{ item.sku }}" data-active="false">
                  {{- item.name }} &ndash; {{ item.colorName -}}
                </h4>
              {% else %}
                <h3 class="current-size" data-sku="{{ item.sku }}" data-active="false">
                  {{- item.name -}}
                  {%- if item.colorSelection %} &ndash; {{ item.colorName -}}{%- endif -%}
                </h3>
                <h4 class="current-size" data-sku="{{ item.sku }}" data-active="false">
                  {{- item.name -}}
                </h4>
              {% endif %}
            {%- else %}
              <h3 class="js-cart-item-name">
                {{- item.name -}}
              </h3>
              {#
              {%- set displayColor = setDisplayColor(type) -%}
              #}
              <h4>{{ item.name }}
                {%- if displayColor %}
                  &ndash; {{ item.colorName -}}
                {%- endif -%}
              </h4>
            {%- endif -%}
          </div>
          <div class="pricing col-xs-3">
            {%- if upsell -%}
              <div class="item" data-sku="{{ item.sku }}" 
                    data-type="{{ item.type }}"
                    data-color="{{ item.color }}"
                    data-price="{{ item.salePrice }}"
                    data-discount="0"
                    {# discount is set at 0 because product discounts are not presently available in the cart #}
                    data-active="false"
                    data-upsell="true"
                    data-quantity="1"
                    data-add-on-available="{{ addOnAvailable }}">
                <h4 class="price">
                  {%- if item.salePrice | round !== item.salePrice -%}
                    {{ item.salePrice.toFixed(2) }}
                  {%- else -%}
                    {{ item.salePrice }}
                  {%- endif -%}
                </h4>
              </div>
              
            {%- else -%}
              {% set originalPrice, salePrice = item.price %}
              {% set discountedItem = item.discount > 0  %}
              <div class="item" data-sku="{{ item.sku }}" 
                    data-type="{{ item.type }}"
                    data-color="{{ item.color }}"
                    data-price="{{ item.salePrice }}"
                    data-discount="{{ item.discount | round(2) }}"
                    data-active="true"
                    data-upsell="false"
                    data-quantity="1"
                    data-add-on-available="{{ addOnAvailable }}">
                <h4 class="{% if discountedItem %}discounted {% endif %}price">
                  {%- if item.salePrice | round !== item.salePrice -%}
                    {{ item.salePrice.toFixed(2) }}
                  {%- else -%}
                    {{ item.salePrice }}
                  {%- endif -%}
                </h4>
                {%- if discountedItem -%}
                  <h4 class="original-price">{{ item.price }}</h4>
                {% endif %}
              </div>
            {% endif -%}
          </div>
        </div>
        <div class="row">
          <div class="col-xs-9">
            <div class="quantity">
              {% set qty = item.quantity %}
              {% if item.quantity == undefined %}
                {% set qty = 1 %}
              {% endif %}
              <button class="qty minus {% if qty == 1 %}disabled{% endif %}" aria-label="Decrease Quantity" tabindex="0">-</button>
              <div class="qty-display" data-quantity="{{ qty }}">
              </div>
              <button class="qty plus" aria-label="Increase Quantity" tabindex="0">+</button>
            </div>
          </div>
        </div>
        <a class="remove" role="button" aria-label="Remove Item" tabindex="0"></a>
      </div>
    </div>

    {# Clyde #}
    {% if addOnAvailable %}
      {% set childSku = getChildSku(item.sku) %}
      {%- for p in products.result -%}
        {%- if p.sku == childSku -%}
          {% set qty = 0 %}
          {% set active = false %}
          {% for x in cart.items %}
            {% if x.sku == p.sku %}
              {% set qty = x.quantity %}
              {% set active = true %}
            {% endif %}
          {% endfor %}

          {% if p.sku.charAt(0) == 6 %}
            {% set type = 'PP' %}
          {% else %}
            {% set type = p.sku.slice(3, -6) %}
          {% endif %}
          <div class="row">
            <div class="addon col-xs-12" 
              data-sku="{{ p.sku }}" 
              data-active="{{ active }}" 
              data-price="{{ p.price }}" 
              data-quantity="{{ qty }}" {% if not active %}style="display: none;"{% endif %}>
              <div class="row">
                <div class="addon-image col-xs-1 col-md-offset-3">
                  <div role="img" aria-label="{{- getProductName(type) }} product image"></div>
                </div>
                <div class="addon-details col-xs-11 col-md-8">
                  <h4 data-price="${{ p.price }}">{{- getProductName(type) -}}</h4>
                  <div class="quantity">
                    {% set qtyDefault = 1 %}
                    {% if active %}
                      {% set qtyDefault = qty %}
                    {% endif %}
                    <button class="qty minus {% if qtyDefault == 1 %}disabled{% endif %}" aria-label="Decrease Quantity" tabindex="0">-</button>
                    <div class="qty-display" data-quantity="{{ qtyDefault }}"></div>
                    <button class="qty plus {% if qty >= item.quantity %}disabled{% endif %}" aria-label="Increase Quantity" tabindex="0">+</button>
                  </div>
                </div>
              </div>
              <a class="remove" title="Remove" role="button" aria-label="Remove Item" tabindex="0"></a>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </li>
  {% endif %}
{%- endmacro -%}

{% macro getUpsells() %}
  {% for u in cart.upsells %}
    {%- set dualSizes = false -%}
    {%- if (u.type == 'DV') or (u.type == 'DD') or (u.type == 'FL') -%}
      {%- set dualSizes = true -%}
      {# is this product a duvet, etc. with sizes like 'twin/twin-xl'? #}
    {%- endif -%}
    <li data-add-on="false"
        data-type="{{ u.type }}" 
        data-color="{{ u.color }}"
        data-active="false">
      <div class="row">
        <div class="product-image col-xs-3">
          <div class="lazyload" role="img" aria-label="{{- u.name }} product image">
            <a data-toggle="modal" href="" data-target="#modal-{{ u.type }}" role="button" tabindex="0" aria-label="Image: {{- u.name -}}"></a>
          </div>
        </div>
        <div class="product-details col-xs-9" data-type="{{ u.type }}">
          <div class="row">
            <div class="details col-xs-9">
              <h3>
                <a data-toggle="modal" href="" data-target="#modal-{{ u.type }}" role="button" tabindex="0">
                  {{- u.name -}}
                </a>
              </h3>
              {%- if u.showStarRating -%}
                <div class="star-rating">
                  <div class="star-gauge">
                    <div class="star-average" style="width: {{ u.avgReviews * 20 }}%" aria-label="{{ u.avgReviews }} Star Average"></div>
                  </div>
                  <p>{{ u.avgReviews | round(1) }}</p>
                </div>
              {%- endif -%}
            </div>
            <div class="pricing col-xs-3">
              {% set discounted = u.price > u.salePrice %}
              <div class="item"
                data-sku="{{ u.sku }}"
                data-type="{{ u.type }}"
                data-color="{{ u.color }}"
                data-price="{{ u.salePrice }}"
                data-out-of-stock="{{ u.outOfStock }}"
                data-active="true">
                <h4 class="{% if discounted %}discounted {% endif %}price">
                  {%- if u.salePrice | round !== u.salePrice -%}
                    {{ u.salePrice.toFixed(2) }}
                  {%- else -%}
                    {{ u.salePrice }}
                  {%- endif -%}
                </h4>
                {%- if discounted -%}
                  <h4 class="original-price">{{ u.price }}</h4>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="row">
            <div class="subtitle col-xs-12">
              <h4>{{ u.subtitle | safe }}</h4>
            </div>
          </div>
          <div class="buttons row">
            <div class="size-select col-xs-6">
              <div class="dropdown">
                <button class="btn btn-sm btn-white dropdown-toggle" type="button" id="upsell-LU-{{ type -}}-{{- color }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" tabindex="0">
                  {% for item in u.skus -%}
                    {%- set active = false -%}
                    {%- if u.sku == item.sku -%}
                      {%- set active = true -%}
                      {# Setting the upsell that corresponds to the cart item as active #}
                    {%- endif -%}

                    {%- set itemOk = false -%}
                    {%- set size = u.sku.slice(9, limit) -%}
                    {%- if u.colorSelection -%}
                      {%- set activeColor = u.colors[0].id -%}
                      {%- for color in u.colors -%}
                        {# Only load specified colors #}
                        {%- set itemColor = item.sku.slice(6, -3) -%}
                        {%- if (itemColor == color.id) -%}
                          {%- set itemOk = true -%}
                        {%- endif -%}
                      {%- endfor -%}
                    {%- else -%}
                      {%- set itemOk = true -%}
                    {%- endif -%}
                    {% if itemOk -%}
                      
                      <div class="current-size" 
                          data-sku="{{ item.sku }}"
                          data-active="{{ active }}"
                          data-color-selection="{{ u.colorSelection }}"
                          data-active-color="{{ activeColor }}"
                          data-longtitle="{{ dualSizes }}">
                        {%- if dualSizes -%}
                          {%- if (upsellSize == 'TW') and (item.size == 'TT') -%}
                            Twin
                          {%- elif (upsellSize == 'TX') and (item.size == 'TT') -%}
                            Twin XL
                          {%- elif (upsellSize == 'FL') and (item.size == 'FQ') -%}
                            Full
                          {%- elif (upsellSize == 'QU') and (item.size == 'FQ') -%}
                            Queen
                          {%- elif (upsellSize == 'KG') and (item.size == 'KC') -%}
                            King
                          {%- elif (upsellSize == 'CK') and (item.size == 'KC') -%}
                            Cal King
                          {%- else -%}
                            {{- item.sizeName -}}
                          {%- endif -%}
                        {%- else -%}
                          {{- item.sizeName -}}
                        {%- endif -%}
                      </div>
                    {%- endif %}
                  {%- endfor %}	
                  {% if u.colorSelection %}
                    <div class="current-size selection-message"
                      data-active-color="{{ activeColor }}"
                      data-active="false">Select Size</div>
                  {%- endif -%}
                </button>
                <ul class="dropdown-menu" aria-labelledby="upsell-LU-{{ u.type -}}-{{- u.color }}" color-selection="{{ u.colorSelection }}">
                  {%- if u.colorSelection -%}
                    {%- set colorCount = u.colors | length -%}
                    {%- set activeColor = u.colors[0].id -%}
                    {%- set activeColorName = u.colors[0].name -%}
                    <li class="color-select">
                      <div class="color-label" 
                        data-active-color="{{ activeColor }}" 
                        data-active-color-name="{{ activeColorName }}"	>
                      </div>
                      <ul>
                        {%- for color in u.colors -%}
                          {%- if loop.index == 1 -%}
                            {%- set active = true -%}
                          {%- else -%}
                            {%- set active = false -%}
                          {%- endif -%}
                          <li data-upsell-colors="{{ colorCount }}" 
                          data-color="{{ color.id }}"
                          data-color-name="{{ color.name }}"
                          data-type="{{ type }}"
                          data-active="{{ active }}"
                          role="button" tabindex="0"></li>
                        {%- endfor -%}
                      </ul>
                    </li>
                  {%- endif -%}

                  <li class="upsell-select">
                    <ul>
                      {%- set count = 0 -%}
                      {%- set totalUpsellSizes = 6 -%}
                      {%- for item in u.skus -%}
                        {%- set active = false -%}
                        {%- if u.sku == item.sku -%}
                          {%- set active = true -%}
                        {%- endif -%}
  
                        {%- set itemOk = false -%}
                        {%- set size = u.sku.slice(9, limit) -%} {# size of associated cart item #}
                        {%- set itemSize = item.sku.slice(9, limit) -%}
                        {%- set itemColor = item.sku.slice(6, -3) -%}
                        {%- if u.colorSelection -%}
                          {%- for color in u.colors -%}
                            {# Only load current size and specified colors #}
                            {%- if (itemColor == color.id) -%}
                              {%- set itemOk = true -%}
                            {%- endif -%}
                          {%- endfor -%}
                        {%- else -%}
                          {%- set itemOk = true -%}
                        {%- endif -%}
                        {%- if itemOk -%}
                          {%- set count = count + 1 -%}
                          {%- if (count == 1) and (itemSize == 'ST') -%}
                            {%- set totalUpsellSizes = 2 -%}
                          {%- endif -%}
                          {%- if (count == 1) and (itemSize == 'TT') -%}
                            {%- set totalUpsellSizes = 3 -%}
                          {%- endif -%}
  
                          <li class="upsell-item"
                              data-sku="{{ item.sku }}"
                              data-type="{{ type }}"
                              data-price="{{ item.price }}"
                              data-out-of-stock="{{ item.outOfStock }}"
                              data-upsell-sizes="{{ totalUpsellSizes }}"
                              data-active="{{ active }}"
                              {%- if u.colorSelection %}
                                data-color-selection="true"
                                data-color="{{ itemColor }}"
                                {%- if itemColor !== activeColor %}
                                  style="display: none;"
                                {%- endif -%}
                              {%- endif -%}
                              role="button" tabindex="0"
                              >
                              <h5>{{ item.sizeName }}</h5>
                              <p>${{ item.price }}</p>
                          </li>
                        {%- endif -%}
                      {%- endfor -%}
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <div class="add-to-cart col-xs-6">
              <a class="btn btn-sm btn-dark block" role="button" tabindex="0">Add to Cart</a>
            </div>
          </div>
        </div>
      </div>
    </li>
  {% endfor %}
{% endmacro %}

{% macro getCrossCategoryUpsells(product) %}
  {%- for u in product -%}
    {% set type = u.priorityProductType %}
    {%- set color = '' -%}
    {% for productColor in u.colorDisplayOrder %}
      {% if loop.index == 1 %}
        {% set color = productColor %}
      {% endif %}
    {% endfor %}
    {%- set size = u.priorityProductSize %}
    {%- set baseSku = 'LU-' + type + '-' + color + '-' + size -%}
    {%- set dualSizes = false -%}
    {%- if (type == 'DV') or (type == 'DD') or (type == 'FL') -%}
      {%- set dualSizes = true -%}
      {# is this product a duvet, etc. with sizes like 'twin/twin-xl'? #}
    {%- endif -%}
    <li data-add-on="false"
        data-type="{{ type }}" 
        data-color="{{ color }}"
        data-active="false">
      <div class="row">
        <div class="product-image col-xs-3">
          <div class="lazyload" role="img" aria-label="{{- u.title }} product image">
            <a data-toggle="modal" href="" data-target="#modal-{{ type }}" role="button" tabindex="0" aria-label="Image: {{- getProductName(type) -}}"></a>
          </div>
        </div>
        <div class="product-details col-xs-9" data-type="{{ type }}">
          <div class="row">
            <div class="details col-xs-9">
              <h3 data-longtitle="{{ checkTitleLength(type) }}">
                <a data-toggle="modal" href="" data-target="#modal-{{ type }}" role="button" tabindex="0">
                  {{- u.title }}
                </a>
              </h3>
              {%- if u.showStarRating -%}
                <div class="star-rating">
                  <div class="star-gauge">
                    <div class="star-average" style="width: {{ u.avgReviews * 20 }}%" aria-label="{{ u.avgReviews }} Star Average"></div>
                  </div>
                  <p>{{ u.avgReviews | round(1) }}</p>
                </div>
              {%- endif -%}
            </div>
            <div class="pricing col-xs-3">
              {% for item in u.skus %}
                {%- set active = false -%}
                {%- if item.sku == baseSku -%}
                  {%- set active = true -%}
                {%- endif -%}

                {# To Do: Discounts need to be pulled from the product DB or wired into the upsell logic #}
                {% set originalPrice, salePrice = item.price %}
                {% set discountedItem = false %}
                {%- if item.discountprice > 0 -%}
                  {% set discountedItem = true %}
                  {% set salePrice = item.discountprice %}
                {%- endif -%}
                {% if item.sku.slice(9, limit) == size %}
                  <div class="item"
                    data-sku="{{ item.sku }}"
                    data-type="{{ item.sku.slice(3, -6) }}"
                    data-color="{{ item.sku.slice(6, -3) }}"
                    data-price="{{ salePrice }}"
                    data-out-of-stock="{{ item.outOfStock }}"
                    data-active="{{ active }}">
                    <h4 class="{% if discountedItem %}discounted {% endif %}price">
                      {%- if salePrice | round !== salePrice -%}
                        {{ salePrice.toFixed(2) }}
                      {%- else -%}
                        {{ salePrice }}
                      {%- endif -%}
                    </h4>
                    {%- if discountedItem -%}
                      <h4 class="original-price">{{ originalPrice }}</h4>
                    {% endif %}
                  </div>
                {% endif %}
              {%- endfor -%}
            </div>
          </div>
          <div class="row">
            <div class="subtitle col-xs-12">
              <h4>{{ u.subtitle | safe }}</h4>
            </div>
          </div>
          <div class="buttons row">
            <div class="size-select col-xs-6">
              <div class="dropdown">
                <button class="btn btn-sm btn-white dropdown-toggle" type="button" id="upsell-LU-{{ type -}}-{{- color }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" tabindex="0">
                  {% for item in u.skus %}
                    {%- set active = false -%}
                    {%- if item.sku == baseSku -%}
                      {%- set active = true -%}
                    {%- endif -%}
                    <div class="current-size" 
                      data-sku="{{ item.sku }}"
                      data-active="{{ active }}"
                      data-color-selection="{{ u.colorSelection }}"
                      data-active-color="{{ color }}"
                      data-longtitle="{{ dualSizes }}">
                      {%- if dualSizes -%}
                        {%- if (upsellSize == 'TW') and (itemSize == 'TT') -%}
                          Twin
                        {%- elif (upsellSize == 'TX') and (itemSize == 'TT') -%}
                          Twin XL
                        {%- elif (upsellSize == 'FL') and (itemSize == 'FQ') -%}
                          Full
                        {%- elif (upsellSize == 'QU') and (itemSize == 'FQ') -%}
                          Queen
                        {%- elif (upsellSize == 'KG') and (itemSize == 'KC') -%}
                          King
                        {%- elif (upsellSize == 'CK') and (itemSize == 'KC') -%}
                          Cal King
                        {%- else -%}
                          {{- item.name -}}
                        {%- endif -%}
                      {%- else -%}
                        {{- item.name -}}
                      {%- endif -%}
                    </div>
                  {%- endfor %}	
                  {% if u.colorSelection %}
                    <div class="current-size selection-message"
                      data-active-color="{{ color }}"
                      data-active="false">Select</div>
                  {%- endif -%}
                </button>
                <ul class="dropdown-menu" aria-labelledby="upsell-LU-{{ type -}}-{{- color }}" color-selection="{{ u.colorSelection }}">
                  {%- if u.colorSelection -%}
                    <li class="color-select">
                      <div class="color-label" 
                        data-active-color="{{ color }}" 
                        data-active-color-name="{{ getColorName(color) }}">
                      </div>
                      <ul>
                        {%- for itemColor in u.colorDisplayOrder -%}
                          {%- if loop.index == 1 -%}
                            {%- set active = true -%}
                          {%- else -%}
                            {%- set active = false -%}
                          {%- endif -%}
                          <li data-upsell-colors="{{ u.colorDisplayOrder | length }}" 
                          data-color="{{ itemColor }}"
                          data-color-name="{{  getColorName(itemColor) }}"
                          data-active="{{ active }}"
                          role="button" tabindex="0"></li>
                        {%- endfor -%}
                      </ul>
                    </li>
                  {%- endif -%}

                  <li class="upsell-select">
                    <ul>		
                      {% for item in u.skus %}
                        {%- set active = false -%}
                        {%- if item.sku == baseSku -%}
                          {%- set active = true -%}
                        {%- endif -%}
                        {% set itemType = item.sku.slice(3, -6) %}
                        {% set itemColor = item.sku.slice(6, -3) %}
                        {% if item.sku.slice(9, limit) == size %}
                          <li class="upsell-item"
                            data-sku="{{ item.sku }}"
                            data-type="{{ itemType }}"
                            data-price="{{ item.price }}"
                            data-out-of-stock="{{ item.outOfStock }}"
                            data-active="{{ active }}"
                            {%- if u.colorSelection %}
                              data-color-selection="true"
                              data-color="{{ itemColor }}"
                              {%- if itemColor !== color %}
                                style="display: none;"
                              {%- endif -%}
                            {%- endif -%}
                            role="button" tabindex="0"
                            >
                            <h5>{{ getShortName(itemType) }}</h5>
                            <p>${{ item.price }}</p>
                          </li>
                        {% endif %}
                      {% endfor %}
                    </ul>
                  </li>

                </ul>
              </div>
            </div>
            <div class="add-to-cart col-xs-6">
              <a class="btn btn-sm btn-dark block" role="button" tabindex="0">Add to Cart</a>
            </div>
          </div>
        </div>
      </div>
    </li>
  {% endfor %}
{% endmacro %}

{% macro getAddOns(skus, product) %}
  {% for sku in skus %}
    {% set active = false %}
    {% for x in cart.items %}
      {% if x.sku == sku %}
        {% set active = true %}
      {% endif %}
    {% endfor %}
    {% if state.cart.summary.state == 'WY' %}
      {% set active = true %}
    {% endif %}
    {% if not active %}
      {% for u in product %}
        {% if sku.charAt(0) == 6 %}
          {# Clyde Protection Plan #}
          {% set type = 'PP' %}
          {%- set size = sku.slice(-2) -%}
        {% else %}
          {%- set type = sku.slice(3, -6) -%}
          {%- set size = sku.slice(9, limit) -%}
        {% endif %}
        {% set parentSku = getParentSku(sku) %}
        <li data-add-on="true"
            data-sku="{{ sku }}"
            data-type="{{ type }}"
            data-size="{{ size }}"
            data-parent-sku="{{ parentSku }}"
            data-active="{{ active }}">
          <div class="row">
            <div class="product-image col-xs-3">
              <div class="lazyload" role="img" aria-label="Image: {{- getProductName(type) }}">
                <a data-gsc-modal="{{ u.gscModal }}" data-gsc-modal-id="{{ u.gscModalId }}" role="button" tabindex="0" aria-label="{{- getProductName(type) -}}"></a>
              </div>
            </div>
            <div class="product-details col-xs-9">
              <div class="row">
                <div class="details col-xs-9">
                  <h3 data-longtitle="{{ checkTitleLength(type) }}">
                    <a data-gsc-modal="{{ u.gscModal }}"
                      data-gsc-modal-id="{{ u.gscModalId }}" 
                      role="button" tabindex="0">
                      {{- getProductName(type) -}}</a>
                  </h3>
                </div>
                <div class="pricing col-xs-3">
                  {%- for item in products.result -%}
                    {%- if item.sku == sku -%}
                      {% set originalPrice, salePrice = item.price %}
                      {% set discountedItem = false %}
                      {%- if item.discountprice > 0 -%}
                        {% set discountedItem = true %}
                        {% set salePrice = item.discountprice %}
                      {%- endif -%}
                      <div class="item"
                          data-sku="{{ item.sku }}"
                          data-price="{{ salePrice }}"
                          data-out-of-stock="{{ item.outOfStock }}">
                          <h4 class="{% if discountedItem %}discounted {% endif %}price">
                            {%- if salePrice | round !== salePrice -%}
                              {{ salePrice.toFixed(2) }}
                            {%- else -%}
                              {{ salePrice }}
                            {%- endif -%}
                          </h4>
                          {%- if discountedItem -%}
                            <h4 class="original-price">{{ originalPrice }}</h4>
                          {% endif %}
                      </div>
                    {%- endif -%}
                  {%- endfor -%}
                </div>
              </div>
              <div class="row">
                <div class="subtitle col-xs-12">
                  <h4>{{ u.subtitle }}</h4>
                </div>
              </div>
              <div class="row">
                <div class="details-left col-xs-12">
                  {%- for item in products.result -%}
                    {%- if item.sku == sku -%}
                      <p>Size: 
                        {% set parentCat = parentSku.slice(3, -6) -%}
                        {%- switch parentCat -%}
                          {%- case 'HY' -%}
                            Luxe
                          {%- default -%}
                            Original
                        {%- endswitch %}
                        {{ item.name -}}
                      </p>
                    {%- endif -%}
                  {%- endfor -%}
                </div>
              </div>
              <div class="buttons row">
                <div class="col-xs-6">
                  <a class="btn btn-sm btn-white block"
                    data-gsc-modal="{{ u.gscModal }}"
                    data-gsc-modal-id="{{ u.gscModalId }}" role="button" tabindex="0">Details</a>
                </div>
                <div class="add-to-cart col-xs-6">
                  <a class="btn btn-sm btn-dark block" role="button" tabindex="0">Add to Cart</a>
                </div>
              </div>
            </div>
          </div>
        </li>
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endmacro %}

{% macro getUpsellModals(product) %}
{% for u in product %}
  {%- set type = u.sku.slice(3, -6) -%}
  {%- set dualSizes = false -%}
  {%- if (type == 'DV') or (type == 'DD') or (type == 'FL') -%}
    {%- set dualSizes = true -%}
    {# is this product a duvet, etc. with sizes like 'twin/twin-xl'? #}
  {%- endif -%}
  {% if u.priorityProductType.length %}
    {% set type = u.priorityProductType %}
  {% endif %}
  <div role="dialog" aria-modal="true" class="modal fade content-modal upsell-modal fullscreen-xs-down" id="modal-{{ type }}" tabindex="-1" data-dual-sizes="{{ dualSizes }}" aria-labelledby="accessory-modal">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" tabindex="0"><span aria-hidden="true"></span></button>
          <div class="row">
            {# Left col on Desktop #}
            <div class="product-gallery col-xs-12 col-sm-6">
              <div class="swiper-container gallery">
                <div class="swiper-wrapper">
                  {% for i in range(1, (u.gallerySlides + 1)) %}
                    <div class="swiper-slide slide-{{ i }} lazyload">
                    </div>
                  {% endfor %}
                </div>
                <div class="swiper-pagination"></div>
              </div>
              {% for details in u.details %}
                <div class="tech-details hidden-xs col-xs-12">
                  <ul>
                    {% for b in details.bullets %}
                      <li>{{ b.bullet }} </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endfor %}
            </div>

            {# Right col on Desktop #}
            <div class="upsell-item col-xs-12 col-sm-6">
              <div class="row">
                <div class="upsell-details col-xs-12">
                  {%- if u.priorityProductType.length -%}
                    <h2 data-longtitle="{{- checkTitleLength(u.priorityProductType) -}}">{{- u.title -}}</h2>
                  {%- else -%}
                    <h2 data-longtitle="{{- checkTitleLength(type) -}}">{{- getProductName(type) -}}</h2>
                  {%- endif -%}
                  {% if u.showStarRating %}
                    <div class="star-rating">
                      <div class="star-gauge">
                        <div class="star-average" style="width: {{ u.avgReviews * 20 }}%;">
                        </div>
                      </div>
                      <p>{{ u.avgReviews | round(1) }} <span>({{ u.totalReviews }})</span></p>
                    </div>
                  {% endif %}
                  <h4>Ships in 1-4 Business Days</h4>
                </div>
              </div>
              <div class="row">
                <div class="swiper-container technicalities col-xs-12">
                  <div class="swiper-pagination"></div>
                  <div class="swiper-wrapper">
                    <div class="swiper-slide tech-details">
                      {% for details in u.details %}
                        <div class="col-xs-12">
                          <p>{{ details.tagline }}</p>
                          <ul class="visible-xs">
                            {% for b in details.bullets %}
                              <li>{{ b.bullet }} </li>
                            {% endfor %}
                          </ul>
                        </div>
                      {% endfor %}

                      {% for r in u.review %}
                        <div class="col-xs-12">
                          <div class="review">
                            <div class="star-rating">
                              <div class="star-gauge">
                                {% set starTotal = (r.starTotal * 20) %}
                                <div class="star-average" style="width: {{ starTotal }}%;">
                                </div> 
                              </div>
                            </div>
                            <h3>{{ r.title }}</h3>
                            <p>{{ r.content }}</p>
                            <p class="reviewer">
                              &ndash; {{ r.reviewer }} <span>(Verified Buyer)</span>
                            </p>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                    <div class="swiper-slide benefits">
                      {% for item in u.benefits %}
                        <div class="item col-xs-10 col-xs-offset-2">
                          <h3 class="{{ item.className }}">{{ item.heading | safe }}</h3>
                          <p>{{ item.content | safe }}</p>
                        </div>
                      {% endfor %}
                    </div>
                    <div class="swiper-slide">
                      {{ _m_modules.specs(products, u.dimensions, u.specs) }}
                    </div>	
                  </div>
                </div> 
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endfor %}
{% endmacro %}

{# Upsell Data #}
{% set mattress = [] %}
{% if cart.upsells.mattress.length %}
  {% for item in cart.upsells.mattress %}	
    {% set mattress = [{
        sku: item.sku,
        quantity: 1,
        size: item.name,
        catId: 1,
        colorSelection: false,
        showStarRating: true,
        avgReviews: reviews.ave,
        totalReviews: reviews.revcount,
        subtitle: 'Lull\'s three layer gel memory foam mattress',
        price: item.price,
        discountPrice: item.discountPrice,
        gallerySlides: 5,
        details: [{
          tagline: 'The mattress protector re-imagined. Ultra sturdy support that\'s easy to assemble.',
          bullets: [
            { bullet: 'Free Shipping and Free Returns' },
            { bullet: '365 Night Trial' },
            { bullet: '1-Year Warranty' }
          ]
        }],
        review: [{
          starTotal: 5,
          title: 'The Bed is Amazing',
          content: 'We slept like freaking babies. It\'s so great! Not too soft or hard, easy sleep and hugs your just right without suffocating you!',
          reviewer: 'Emily R.'
        }],
        benefits: [
          {
            heading: '100% Waterproof',
            className: 'waterproof',
            content: 'The Lull Protector keeps liquids from reaching your mattress using a 100% waterproof barrier.'
          },
          {
            heading: 'Stain Resistant',
            className: 'stain',
            content: 'The Lull Protector uses chemical-free, stain-resistant fibers to repel liquids.'
          },
          {
            heading: 'Hypoallergenic',
            className: 'hypoallergenic',
            content: 'Machine washable to prevent a buildup of skin cells and dust mites (a common household allergen) on your mattress.'
          },
          {
            heading: 'Quiet',
            className: 'quiet',
            content: 'Unlike traditional noisy protectors, the Lull Protector won\t move or crinkle beneath you. We use the same soft fabrics as the Lull Mattress cover for a perfect fit and a quiet night\s sleep.'
          },
          {
            heading: 'Breathable',
            className: 'breathable',
            content: 'Lull\s protection uses technology to allow air to pass through for a cool night\s sleep.'
          },
          {
            heading: 'Lasting Protection',
            className: 'protection',
            content: 'Built to handle wear-and-tear, the Lull Protector keeps your mattress clean so you get years of enjoyment from your Lull Mattress.'
          }
        ],
        dimensions: [
          {
            catId: 8,
            dimensions: [
              { size: 'TW', w: '39"', l: '75"', h: '', totalHeight: '', weight: '4 lbs.' },
              { size: 'TX', w: '39"', l: '80"', h: '', totalHeight: '', weight: '4 lbs.' },
              { size: 'FL', w: '54"', l: '75"', h: '', totalHeight: '', weight: '4.5 lbs.' },
              { size: 'QU', w: '60"', l: '80"', h: '', totalHeight: '', weight: '4.75 lbs.' },
              { size: 'KG', w: '76"', l: '80"', h: '', totalHeight: '', weight: '6 lbs.' },
              { size: 'CK', w: '72"', l: '84"', h: '', totalHeight: '', weight: '6 lbs.' },
              { size: 'BOX', w: '15"', l: '12"', h: '5.75"', totalHeight: '', weight: '' }
            ]
          }
        ],
        specs: [
          {
            heading: '',
            details: [
              {
                item: 'Construction',
                details: '<strong>Knit Top:</strong> Polyester &amp; Rayon<br><strong>Skirting:</strong> Polyester &amp; Spandex',
                classes: 'construction col-xs-1'
              },
              {
                item: 'Shipping Info',
                details: 'FedEx Ground',
                classes: 'shipping col-xs-1'
              },
              {
                item: 'clearfix',
                details: '',
                classes: 'visible-xs'
              },
              {
                item: 'Shipping Costs',
                details: 'Free Shipping &amp; Returns',
                classes: 'shipping-costs col-xs-1'
              },
              {
                item: 'Warranty',
                details: '1 year',
                classes: 'warranty col-xs-1'
              }
            ]
          }
        ]
      }]
    %}
  {% endfor %}
{% endif %}

{% set protector = [] %}
{% if cart.upsells.protector.length %}
  {% for item in cart.upsells.protector %}	
    {% set protector = [{
        sku: item.sku,
        quantity: 1,
        size: item.name,
        catId: 8,
        colorSelection: false,
        showStarRating: true,
        avgReviews: avgReviews8,
        totalReviews: totalReviews8,
        subtitle: '100% waterproof barrier provides<br class="hidden-xs"> lasting protection',
        price: item.price,
        discountPrice: item.discountPrice,
        gallerySlides: 3,
        details: [{
          tagline: 'The mattress protector re-imagined. Ultra sturdy support that\'s easy to assemble.',
          bullets: [
            { bullet: 'Free Shipping and Free Returns' },
            { bullet: '365 Night Trial' },
            { bullet: '1-Year Warranty' }
          ]
        }],
        review: [{
          starTotal: 5,
          title: 'This mattress protector fits perfectly!',
          content: 'This mattress protector fits perfectly! It doesn\'t stretch out even after a night\'s sleep!',
          reviewer: 'Barbara B.'
        }],
        benefits: [
          {
            heading: '100% Waterproof',
            className: 'waterproof',
            content: 'The Lull Protector keeps liquids from reaching your mattress using a 100% waterproof barrier.'
          },
          {
            heading: 'Stain Resistant',
            className: 'stain',
            content: 'The Lull Protector uses chemical-free, stain-resistant fibers to repel liquids.'
          },
          {
            heading: 'Hypoallergenic',
            className: 'hypoallergenic',
            content: 'Machine washable to prevent a buildup of skin cells and dust mites (a common household allergen) on your mattress.'
          },
          {
            heading: 'Quiet',
            className: 'quiet',
            content: 'Unlike traditional noisy protectors, the Lull Protector won\t move or crinkle beneath you. We use the same soft fabrics as the Lull Mattress cover for a perfect fit and a quiet night\s sleep.'
          },
          {
            heading: 'Breathable',
            className: 'breathable',
            content: 'Lull\s protection uses technology to allow air to pass through for a cool night\s sleep.'
          },
          {
            heading: 'Lasting Protection',
            className: 'protection',
            content: 'Built to handle wear-and-tear, the Lull Protector keeps your mattress clean so you get years of enjoyment from your Lull Mattress.'
          }
        ],
        dimensions: [
          {
            catId: 8,
            dimensions: [
              { size: 'TW', w: '39"', l: '75"', h: '', totalHeight: '', weight: '4 lbs.' },
              { size: 'TX', w: '39"', l: '80"', h: '', totalHeight: '', weight: '4 lbs.' },
              { size: 'FL', w: '54"', l: '75"', h: '', totalHeight: '', weight: '4.5 lbs.' },
              { size: 'QU', w: '60"', l: '80"', h: '', totalHeight: '', weight: '4.75 lbs.' },
              { size: 'KG', w: '76"', l: '80"', h: '', totalHeight: '', weight: '6 lbs.' },
              { size: 'CK', w: '72"', l: '84"', h: '', totalHeight: '', weight: '6 lbs.' },
              { size: 'BOX', w: '15"', l: '12"', h: '5.75"', totalHeight: '', weight: '' }
            ]
          }
        ],
        specs: [
          {
            heading: '',
            details: [
              {
                item: 'Construction',
                details: '<strong>Knit Top:</strong> Polyester &amp; Rayon<br><strong>Skirting:</strong> Polyester &amp; Spandex',
                classes: 'col-xs-12 col-sm-7'
              },
              {
                item: 'Shipping Info',
                details: 'Ships in 1-4 business days',
                classes: 'col-xs-12 col-sm-5'
              },
              {
                item: 'clearfix',
                details: '',
                classes: 'visible-xs'
              },
              {
                item: 'Shipping Costs',
                details: 'Free Shipping &amp; Returns',
                classes: 'col-xs-12 col-sm-7'
              },
              {
                item: 'Warranty',
                details: '1 year',
                classes: 'col-xs-12 col-sm-5'
              }
            ]
          }
        ]
      }]
    %}
  {% endfor %}
{% endif %}

{% set pillow = [] %}
{% if cart.upsells.pillow.length %}
  {% for item in cart.upsells.pillow %}	
    {% set pillow = [{
        sku: item.sku,
        quantity: 1,
        size: item.name,
        catId: 9,
        colorSelection: false,
        showStarRating: true,
        avgReviews: avgReviews9,
        totalReviews: totalReviews9,
        subtitle: 'Adaptive construction supports<br class="visible-sm visible-md"> every sleeper',
        price: item.price,
        discountPrice: item.discountPrice,
        gallerySlides: 6,
        details: [{
          tagline: 'Fall asleep quickly and wake up rested with Lull\'s premium pillow.',
          bullets: [
            { bullet: 'Free Shipping and Free Returns' },
            { bullet: '365 Night Trial' },
            { bullet: '1-Year Warranty' }
          ]
        }],
        review: [{
          starTotal: 5,
          title: 'The Bed is Amazing',
          content: 'We slept like freaking babies. It\'s so great! Not too soft or hard, easy sleep and hugs your just right without suffocating you!',
          reviewer: 'Emily R.'
        }],
        benefits: [
          {
            heading: 'Comfort',
            className: 'comfort',
            content: 'The top and bottom layers of the Lull Pillow contain opened microfibers for a soft place to rest your head.'
          },
          {
            heading: 'Support',
            className: 'support',
            content: 'The inner layer of the Lull Pillow contains dense microfibers to provide support and align your spine.'
          },
          {
            heading: 'Adaptive',
            className: 'breathable',
            content: 'Millions of small microfibers allow air to pass through your pillow for a cool night\'s sleep.'
          },
          {
            heading: 'Durable',
            className: 'durable',
            content: 'Made from high quality cotton and microfibers, the Lull Pillow will keep you dreaming for many nights to come.'
          },
          {
            heading: 'Machine Washable',
            className: 'washable',
            content: 'The Lull Pillow is machine washable and tested to ensure minimal shrinkage.'
          },
          {
            heading: 'Hypoallergenic',
            className: 'hypoallergenic',
            content: 'Lull\'s down alternative fibers are hygienic, high-quality, and free of allergens.'
          }
        ],
        dimensions: [
          {
            catId: 9,
            dimensions: [
              { size: 'ST', w: '26"', l: '18"', h: '2"', totalHeight: '', weight: '5.4 lbs.' },
              { size: 'KG', w: '34"', l: '18"', h: '2"', totalHeight: '', weight: '6 lbs.' },
              { size: 'BOX', w: '25"', l: '17"', h: '6"', totalHeight: '', weight: '' }
            ]
          }
        ],
        specs: [
          {
            heading: '',
            details: [
              {
                item: 'Construction',
                details: 'Microfiber &amp; Sateen',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Shipping Info',
                details: 'Ships in 1-4 business days',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'clearfix',
                details: '',
                classes: 'visible-xs'
              },
              {
                item: 'Shipping Costs',
                details: 'Free Shipping &amp; Returns',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Warranty',
                details: '1 year',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Care Instructions',
                details: 'Machine wash cold, delicate cycle, mild detergent. Tumble dry, low heat with dryer balls or clean tennis balls.',
                classes: 'col-xs-12'
              }
            ]
          }
        ]
      }]
    %}
  {% endfor %}
{% endif %}

{% set metalFrame = [] %}
{% if cart.upsells.metalFrame.length %}
  {% for item in cart.upsells.metalFrame %}	
    {% set metalFrame = [{
        sku: item.sku,
        quantity: 1,
        size: item.name,
        catId: 10,
        colorSelection: false,
        showStarRating: true,
        avgReviews: avgReviews10,
        totalReviews: totalReviews10,
        subtitle: 'Easy to assemble bed frame with under<br class="visible-md visible-lg"> bed storage',
        price: item.price,
        discountPrice: item.discountPrice,
        gallerySlides: 4,
        details: [{
          tagline: 'Complement your new mattress with Lull\'s versatile and affordable Arrellaga folding bed frame.',
          bullets: [
            { bullet: 'Free Shipping and Free Returns' },
            { bullet: '365 Night Trial' },
            { bullet: '1-Year Warranty' }
          ]
        }],
        review: [{
          starTotal: 5,
          title: 'Best bed frame ever',
          content: 'Love the frame. Super easy to set up. Snaps together real nice.',
          reviewer: 'James W.'
        }],
        benefits: [
          {
            heading: 'Easy to Assemble',
            className: 'easy',
            content: 'Assembled in minutes &ndash; no tools needed.'
          },
          {
            heading: 'Under-Bed Storage',
            className: 'storage',
            content: 'The Lull Arrellaga Folding Bed Frame allows for 13 of valuable storage space.'
          },
          {
            heading: 'Durable Support',
            className: 'durable',
            content: 'The Lull Arrellaga Folding Bed Frames solid steel construction provides long-lasting support and durability &ndash; no box spring needed.'
          },
          {
            heading: 'Quiet',
            className: 'quiet',
            content: 'Unlike traditional noisy protectors, the Lull Protector won\t move or crinkle beneath you. We use the same soft fabrics as the Lull Mattress cover for a perfect fit and a quiet night\s sleep.'
          },
          {
            heading: 'Versatile Foundation',
            className: 'versatile',
            content: 'Lull\'s metal grid design supports a variety of mattress types. The Lull Arrellaga Folding Bed Frame can fit inside most bed frames or replace the need for a bed frame altogether.'
          },
          {
            heading: 'Convenient Folding Design',
            className: 'folding',
            content: 'The Lull Arrellaga Folding Bed Frame folds to a space-saving size for storage and maneuvering in tight spaces.'
          }
        ],
        dimensions: [
          {
            catId: 10,
            dimensions: [
              { size: 'TW', w: '39"', l: '75"', h: '14"', totalHeight: '', weight: '28 lbs.' },
              { size: 'TX', w: '39"', l: '80"', h: '14"', totalHeight: '', weight: '29 lbs.' },
              { size: 'FL', w: '54"', l: '75"', h: '14"', totalHeight: '', weight: '42 lbs.' },
              { size: 'QU', w: '60"', l: '80"', h: '14"', totalHeight: '', weight: '47 lbs.' },
              { size: 'KG', w: '76"', l: '80"', h: '14"', totalHeight: '', weight: '56 lbs.' },
              { size: 'CK', w: '72"', l: '84"', h: '14"', totalHeight: '', weight: '53 lbs.' },
              { size: 'BOX', w: '41"', l: '31"', h: '6"', totalHeight: '', weight: '' }
            ]
          }
        ],
        specs: [
          {
            heading: '',
            details: [
              {
                item: 'Construction',
                details: 'Steel',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Shipping Info',
                details: 'Ships in 1-4 business days, single box',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'clearfix',
                details: '',
                classes: 'visible-xs'
              },
              {
                item: 'Shipping Costs',
                details: 'Free Shipping &amp; Returns',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Warranty',
                details: '5 years',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'clearfix',
                details: '',
                classes: 'visible-xs'
              },
              {
                item: 'Care Instructions',
                details: 'Dust with a soft dry cloth',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Assembly Instructions',
                details: '<a href="https://static.lull.com/media/The_Lull_Metal_Bed_Frame_Assembly_Instructions.pdf" target="_blank">Click here</a> to download',
                classes: 'col-xs-12 col-sm-6'
              }
            ]
          }
        ]
      }]
    %}
  {% endfor %}
{% endif %}

{% set woodFrame = [] %}
{% if cart.upsells.woodFrame.length %}
  {% for item in cart.upsells.woodFrame %}	
    {% set woodFrame = [{
        sku: item.sku,
        quantity: 1,
        size: item.name,
        catId: 11,
        colorSelection: false,
        showStarRating: true,
        avgReviews: avgReviews11,
        totalReviews: totalReviews11,
        subtitle: 'Modern design built with your Lull mattress<br class="visible-lg"> in mind',
        price: item.price,
        discountPrice: item.discountPrice,
        gallerySlides: 5,
        details: [{
          tagline: 'Support your new mattress and complete your bedroom with Lull\'s modern platform bed.',
          bullets: [
            { bullet: 'Free Shipping and Free Returns' },
            { bullet: '365 Night Trial' },
            { bullet: '1-Year Warranty' }
          ]
        }],
        review: [{
          starTotal: 5,
          title: 'Great frame',
          content: 'Package was easy to handle. Matched the picture completely and the width and height are perfect for our bedroom. Very classy and easy to set up.',
          reviewer: 'Emily C.'
        }],
        benefits: [
          {
            heading: 'Quality Craftsmanship',
            className: 'craftsmanship',
            content: 'The Lull Platform Bed provides durability that lasts &ndash; made from pine wood and steel rail fittings.'
          },
          {
            heading: 'No Box Spring Needed',
            className: 'boxspring',
            content: 'The Lull Platform Bed Frame is the perfect complement to any style mattress &ndash; no box spring needed.'
          },
          {
            heading: 'Spine Alignment',
            className: 'support',
            content: 'The Lull Platform Bed Frame\'s slatted design works with your Lull Mattress to keep your back aligned and ensure quality sleep.'
          },
          {
            heading: 'Flexible Support',
            className: 'flexible',
            content: 'The Lull Platform Bed Frame adjusts to different sleeper types by absorbing body movements.'
          },
          {
            heading: 'Easy to Assemble',
            className: 'easy',
            content: 'Assembles in 5 easy steps in under 10 minutes &ndash; the only tools needed are an allen wrench (included) and a phillips head screwdriver (not included).'
          },
          {
            heading: 'Modern Design',
            className: 'modern',
            content: 'Lull\s contemporary platform frame is an excellent addition to any bedroom with its stylish wood finish and simple design.'
          }
        ],
        dimensions: [
          {
            catId: 11,
            dimensions: [
              { size: 'TW', w: '41"', l: '76.5"', h: '13.5"', totalHeight: '', weight: '68 lbs.' },
              { size: 'TX', w: '41"', l: '81.5"', h: '13.5"', totalHeight: '', weight: '71 lbs.' },
              { size: 'FL', w: '55.7"', l: '76.8"', h: '14"', totalHeight: '', weight: '61 lbs.' },
              { size: 'QU', w: '60.6"', l: '81.7"', h: '14"', totalHeight: '', weight: '61 lbs.' },
              { size: 'KG', w: '77.7"', l: '81.7"', h: '14"', totalHeight: '', weight: '62 lbs.' },
              { size: 'CK', w: '73.7"', l: '85.7"', h: '14"', totalHeight: '', weight: '82 lbs.' },
              { size: 'BOX', w: 'A: 67" x 16" x 5"', l: 'B: 83" x 10" x 3"', h: '', totalHeight: '', weight: '' }
            ]
          }
        ],
        specs: [
          {
            heading: '',
            details: [
              {
                item: 'Construction',
                details: 'Pine Wood &amp; Steel',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Shipping Info',
                details: 'Ships in 1-4 business days',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'clearfix',
                details: '',
                classes: 'visible-xs'
              },
              {
                item: 'Shipping Costs',
                details: 'Free Shipping &amp; Returns',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Warranty',
                details: '1 year',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'clearfix',
                details: '',
                classes: 'visible-xs'
              },
              {
                item: 'Care Instructions',
                details: 'Dust with a soft dry cloth',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Assembly Instructions',
                details: '<a href="https://static.lull.com/media/The_Lull_Platform_Bed_Frame_Insert_Booklet.pdf" target="_blank">Click here</a> to download',
                classes: 'col-xs-12 col-sm-6'
              }
            ]
          }
        ]
      }]
    %}
  {% endfor %}
{% endif %}


{% if cart.upsells.sheets.length %}
  {% set sheetsSize = '' %}
  {% set sizes = ['TW', 'TX', 'FL', 'QU', 'KG', 'CK'] %}
  {% set prioritySheetsType = 'CB' %}
  {% for item in cart.items %}
    {% if item.sku.slice(3, -6) == 'HY' %}
      {% set prioritySheetsType = 'OC' %}
      {% for size in sizes %}
        {% if item.sku.slice(9, limit) == size %}
          {% set sheetsSize = size %}
          {# finds largest Hybrid in cart #}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}
  {% if cart.upsells.sheets.length and sheetsSize == '' %}
    {% for item in cart.upsells.sheets %}	
      {% for size in sizes %}
        {% if sheetsSize == '' and item.sku.slice(9, limit) == size %}
          {% set sheetsSize = size %}
        {% endif %}
      {% endfor %}
    {% endfor %}
  {% endif %}
  {% set sheets = [] %}
  {% set sheets = [{
    sku: 'LU-CB-BW-TW',
    skus: cart.upsells.sheets,
    quantity: 1,
    priorityProductType: prioritySheetsType,
    priorityProductSize: sheetsSize,
    productTypeOrder: ['CB', 'CS', 'OC'],
    colorSelection: true,
    colorDisplayOrder: ['BW', 'QG', 'GG', 'MB', 'PA', 'WP', 'CD'],
    showStarRating: true,
    avgReviews: avgReviews16,
    totalReviews: totalReviews16,
    title: 'Lull Sheets',
    subtitle: '<span data-type="CB">Silky, soft, and breathable  high quality sheets at an unbeatable price.</span><span data-type="CS">Premium 100% cotton percale sheets made for a cool night\'s sleep.</span><span data-type="OC">100% organic cotton sheets crafted with comfort, wellness, and luxury in mind.</span>',
    price: item.price,
    discountPrice: item.discountPrice,
    gallerySlides: 4,
    details: [{
      tagline: 'Bedding that keeps you just the
      right temperature',
      bullets: [
        { bullet: 'Free Shipping and Free Returns' },
        { bullet: '365 Night Trial' },
        { bullet: '1-Year Warranty' }
      ]
    }],
    review: [{
      starTotal: 5,
      title: 'Like pure luxury',
      content: 'Excellent! Feels like the sheets of the most luxurious hotel-stay room imaginable.',
      reviewer: 'Harry M.'
    }],
    benefits: [
      {
        heading: 'Breathable',
        className: 'breathable',
        content: 'Stay cool in summer and warm in winter. The Lull Sheets use a three-over, one-under specialty weave that\'s ideal for year-round comfort.'
      },
      {
        heading: 'Safe',
        className: 'safe',
        content: 'The Lull Sheets are Standard 100 by Oeko-Tex certified, which means they are tested and verified to be free from harmful levels of more than 300 substances.'
      },
      {
        heading: 'Smart',
        className: 'modern',
        content: 'Special tags on the fitted sheet help you to quickly identify the top, bottom and sides.'
      },
      {
        heading: 'Perfect Fit',
        className: 'fit',
        content: 'The Lull Sheets are designed to be the perfect fit for your	Lull Mattress and mattresses up to 15".'
      }
    ],
    dimensions: [
      {
        catId: 16,
        dimensions: [
          { size: 'TW', color: 'WH', fitted: '39" x 75" x 15"', flat: '71 x 98"', pillowcase: '20" x 27"' },
          { size: 'TX', color: 'WH', fitted: '39" x 80" x 15"', flat: '71" x 104"', pillowcase: '20" x 27"' },
          { size: 'FL', color: 'WH', fitted: '54" x 75" x 15"', flat: '86" x 98"', pillowcase: '20" x 27"' },
          { size: 'QU', color: 'WH', fitted: '60" x 80" x 15"', flat: '92" x 104"', pillowcase: '20" x 27"' },
          { size: 'KG', color: 'WH', fitted: '78" x 80" x 15"', flat: '110" x 104"', pillowcase: '20" x 37"' },
          { size: 'CK', color: 'WH', fitted: '72" x 84" x 15"', flat: '110" x 104"', pillowcase: '20" x 37"' },
          { size: 'BOX', dimensions: '17" x 9" x 4"' }
        ]
      }
    ],
    specs: [
      {
        heading: '',
        columns: [
          {
            size: true,
            dimensions: false,
            shippingWeight: false,
            fittedSheet: true,
            flatSheet: true,
            pillowcase: true
          }
        ],
        details: [
          {
            item: 'Construction',
            details: '100% Cotton',
            classes: 'col-xs-12 col-sm-6'
          },
          {
            item: 'Shipping Info',
            details: 'Ships in 1-4 business days',
            classes: 'col-xs-12 col-sm-6'
          },
          {
            item: 'clearfix',
            details: '',
            classes: 'visible-xs'
          },
          {
            item: 'Shipping Costs',
            details: 'Free Shipping &amp; Returns',
            classes: 'col-xs-12 col-sm-6'
          },
          {
            item: 'Warranty',
            details: '1 year',
            classes: 'col-xs-12 col-sm-6'
          }
        ]
      }
    ]
  }]%}
{% endif %}



{% set duvet = [] %}
{% if cart.upsells.duvet.length %}
  {% for item in cart.upsells.duvet %}	
    {% set duvet = [{
        sku: item.sku,
        quantity: 1,
        size: item.name,
        catId: 19,
        colorSelection: false,
        showStarRating: true,
        avgReviews: avgReviews19,
        totalReviews: totalReviews19,
        subtitle: 'Made of premium materials that you can see and feel',
        price: item.price,
        discountPrice: item.discountPrice,
        gallerySlides: 6,
        details: [{
          tagline: 'Get amazing sleep with the Original Lull Duvet. Millions of premium fibers keep you warm in the winter and cool in the summer.',
          bullets: [
            { bullet: 'Free Shipping and Free Returns' },
            { bullet: '365 Night Trial' },
            { bullet: '1-Year Warranty' }
          ]
        }],
        review: [{
          starTotal: 5,
          title: 'Everybody should have one!',
          content: 'It\'s very cool in the summer and warm in the winter, good for pretty much every season.',
          reviewer: 'Brenda'
        }],
        benefits: [
          {
            heading: 'All-Season',
            className: 'all-season',
            content: 'Get cozy year-round with Lull\'s ideal fill weight. The Original Lull Duvet provides the perfect cover for every season.'
          },
          {
            heading: 'High Quality',
            className: 'comfort',
            content: 'The Original Lull Duvet\'s premium cotton and microfibers provide quality that you can see and feel.'
          },
          {
            heading: 'Oversized',
            className: 'oversized',
            content: 'The Original Lull Duvet is oversized and extra comfortable, putting an end to fights over the covers.'
          },
          {
            heading: 'Clump Resistant',
            className: 'versatile',
            content: 'The Original Lull Duvet\'s unique fill technique evenly distributes fill and prevents clumping.'
          },
          {
            heading: 'Hypoallergenic',
            className: 'hypoallergenic',
            content: 'The Original Lull Duvet contains down alternative fibers that are hygienic, high-quality, and
            free of allergens.'
          },
          {
            heading: 'Stays in Place',
            className: 'loops',
            content: 'Equipped with corner loops so	you won\'t have to worry about the Original Lull Duvet shifting in
            its cover.'
          }
        ],
        dimensions: [
          {
            catId: 19,
            dimensions:	[
              { size: 'TT', w: '68"', l: '88', h: '', totalHeight: '', weight: '7 lbs' },
              { size: 'FQ', w: '88"', l: '98"', h: '', totalHeight: '', weight: '8.8 lbs.' },
              { size: 'KC', w: '107"', l: '98"', h: '', totalHeight: '', weight: '10 lbs.' },
              { size: 'BOX', w: '24"', l: '24"', h: '8"', totalHeight: '', weight: '' }
            ]
          }
        ],
        specs: [
          {
            heading: '',
            details: [
              {
                item: 'Construction',
                details: '<strong>Shell:</strong> 100% Cotton<br><strong>Fill:</strong> 100% Polyester',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Shipping Info',
                details: 'Ships in 1-4 business days',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'clearfix',
                details: '',
                classes: ''
              },
              {
                item: 'Shipping Costs',
                details: 'Free Shipping &amp; Returns',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Warranty',
                details: '1 year',
                classes: 'col-xs-12 col-sm-6'
              }
            ]
          }
        ]
      }]
    %}
  {% endfor %}
{% endif %}

{% set foundation = [] %}
{% if cart.upsells.foundation.length %}
  {% for item in cart.upsells.foundation %}	
    {% set foundation = [{
        sku: item.sku,
        quantity: 1,
        size: item.name,
        catId: 20,
        colorSelection: false,
        showStarRating: true,
        avgReviews: avgReviews20,
        totalReviews: totalReviews20,
        subtitle: 'Designed to absorb movement and<br class="visible-md visible-lg"> reduce wear',
        price: item.price,
        discountPrice: item.discountPrice,
        gallerySlides: 5,
        details: [{
          tagline: 'Give your mattress the support it needs with Lull\'s easy to assemble foundation.',
          bullets: [
            { bullet: 'Free Shipping and Free Returns' },
            { bullet: '365 Night Trial' },
            { bullet: '1-Year Warranty' }
          ]
        }],
        review: [{
          starTotal: 5,
          title: 'Great product!',
          content: 'The foundation was easy to assemble and the directions were simple, not intimidating. Set up was done in less than an hour. It\'s super sturdy and goes with any room!',
          reviewer: 'Valerie J.'
        }],
        benefits: [
          {
            heading: 'Easy',
            className: 'easy',
            content: 'No tools required. The Lull Foundation can be assembled and disassembled in less than five minutes.'
          },
          {
            heading: 'Breathable',
            className: 'breathable',
            content: 'The slatted design ensures optimum support & maximum air flow.'
          },
          {
            heading: 'Hypoallergenic',
            className: 'hypoallergenic',
            content: 'The foundation is crafted from high-strength engineered wood and wrapped in a luxurious grey stretch knit fabric.'
          }
        ],
        dimensions: [
          {
            catId: 20,
            dimensions: [
              { size: 'TW', w: '37.5"', l: '74"', h: '7.5"', totalHeight: '17.5"', weight: '54 lbs.' },
              { size: 'TX', w: '37.5"', l: '79"', h: '7.5"', totalHeight: '17.5"', weight: '56 lbs.' },
              { size: 'FL', w: '52.5"', l: '74"', h: '7.5"', totalHeight: '17.5"', weight: '69 lbs.' },
              { size: 'QU', w: '59.5"', l: '79"', h: '7.5"', totalHeight: '17.5"', weight: '75 lbs.' },
              { size: 'KG', w: '75.5"', l: '79"', h: '7.5"', totalHeight: '17.5"', weight: '94 lbs.' },
              { size: 'CK', w: '71.5"', l: '83"', h: '7.5"', totalHeight: '17.5"', weight: '86 lbs.' },
              { size: 'BOX', w: '78"', l: '15.5"', h: '9"', totalHeight: '', weight: '' }
            ]
          }
        ],
        specs: [
          {
            heading: '',
            details: [
              {
                item: 'Construction',
                details: 'Frame: Laminated Veneer Lumber (LVL)<br>Fabric: 100% Polyester',
                classes: 'col-xs-12'
              },
              {
                item: 'Shipping Info',
                details: 'Ships in 1-4 business days',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Shipping Costs',
                details: 'Free Shipping &amp; Returns',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'clearfix',
                details: '',
                classes: 'visible-sm'
              },
              {
                item: 'Warranty',
                details: '3 year',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Assembly Instructions',
                details: '<a href="https://static.lull.com/media/foundation/lull-foundation-instructions.pdf" target="_blank">Click here</a> to download',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Leg Kit <span class="visible-lg-inline">Assembly</span> Instructions',
                details: '<a href="https://static.lull.com/media/foundation/lull-foundation-with-legs-instructions.pdf" target="_blank">Click here</a> to download',
                classes: 'col-xs-12'
              }
            ]
          }
        ]
      }]
    %}
  {% endfor %}
{% endif %}

{% set foundationLegs = [] %}
{# Foundation legs are currently the Foundation specs #}
{% if cart.upsells.foundationLegs.length %}
  {% for item in cart.upsells.foundationLegs %}	
    {% set foundationLegs= [{
        sku: item.sku,
        quantity: 1,
        size: item.name,
        catId: 22,
        colorSelection: false,
        showStarRating: false,
        avgReviews: avgReviews22,
        totalReviews: totalReviews22,
        subtitle: 'Make your foundation a platform bed',
        price: item.price,
        discountPrice: item.discountPrice,
        gallerySlides: 3,
        details: [{
          tagline: 'Add height and create instant under-bed storage',
          bullets: [
            { bullet: 'Free Shipping and Free Returns' },
            { bullet: '365 Night Trial' },
            { bullet: '1-Year Warranty' }
          ]
        }],
        review: [{
          starTotal: 5,
          title: 'Great product!',
          content: 'The foundation was easy to assemble and the directions were simple, not intimidating. Set up was done in less than an hour. It\'s super sturdy and goes with any room!',
          reviewer: 'Valerie J.'
        }],
        benefits: [
          {
            heading: 'Easy',
            className: 'easy',
            content: 'No tools required. The Lull Foundation can be assembled and disassembled in less than five minutes.'
          },
          {
            heading: 'Breathable',
            className: 'breathable',
            content: 'The slatted design ensures optimum support & maximum air flow.'
          },
          {
            heading: 'Hypoallergenic',
            className: 'hypoallergenic',
            content: 'The foundation is crafted from high-strength engineered wood and wrapped in a luxurious grey stretch knit fabric.'
          }
        ],
        dimensions: [					
          {
            catId: 20,
            dimensions: [
              { size: 'TW', w: '37.5"', l: '74"', h: '7.5"', totalHeight: '17.5"', weight: '54 lbs.' },
              { size: 'TX', w: '37.5"', l: '79"', h: '7.5"', totalHeight: '17.5"', weight: '56 lbs.' },
              { size: 'FL', w: '52.5"', l: '74"', h: '7.5"', totalHeight: '17.5"', weight: '69 lbs.' },
              { size: 'QU', w: '59.5"', l: '79"', h: '7.5"', totalHeight: '17.5"', weight: '75 lbs.' },
              { size: 'KG', w: '75.5"', l: '79"', h: '7.5"', totalHeight: '17.5"', weight: '94 lbs.' },
              { size: 'CK', w: '71.5"', l: '83"', h: '7.5"', totalHeight: '17.5"', weight: '86 lbs.' },
              { size: 'BOX', w: '78"', l: '15.5"', h: '9"', totalHeight: '', weight: '' }
            ]
          }
        ],
        specs: [
          {
            heading: '',
            details: [
              {
                item: 'Construction',
                details: 'Frame: Laminated Veneer Lumber (LVL)<br>Fabric: 100% Polyester',
                classes: 'col-xs-12'
              },
              {
                item: 'Shipping Info',
                details: 'Ships in 1-4 business days',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Shipping Costs',
                details: 'Free Shipping &amp; Returns',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'clearfix',
                details: '',
                classes: 'visible-sm'
              },
              {
                item: 'Warranty',
                details: '3 year',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Assembly Instructions',
                details: '<a href="https://static.lull.com/media/foundation/lull-foundation-instructions.pdf" target="_blank">Click here</a> to download',
                classes: 'col-xs-12 col-sm-6'
              },
              {
                item: 'Leg Kit <span class="visible-lg-inline">Assembly</span> Instructions',
                details: '<a href="https://static.lull.com/media/foundation/lull-foundation-with-legs-instructions.pdf" target="_blank">Click here</a> to download',
                classes: 'col-xs-12'
              }
            ]
          }
        ]
      }]
    %}
  {% endfor %}
{% endif %}

{% set luxeHybrid = [] %}
{% if cart.upsells.luxeHybrid.length %}
  {% for item in cart.upsells.luxeHybrid %}	
    {% set luxeHybrid = [{
        sku: item.sku,
        quantity: 1,
        size: item.name,
        catId: 28,
        colorSelection: false,
        showStarRating: false,
        avgReviews: avgReviews28,
        totalReviews: totalReviews28,
        subtitle: 'A luxurious combination of comfort, support, and cooling technology',
        price: item.price,
        discountPrice: item.discountPrice,
        gallerySlides: 5,
        details: [{
          tagline: 'Multi-layer foam combined with supportive coil technology creates the ultimate sleep experience.',
          bullets: [
            { bullet: 'Free Shipping and Free Returns' },
            { bullet: '365 Night Trial' },
            { bullet: '1-Year Warranty' }
          ]
        }],
        review: [{
          starTotal: 5,
          title: 'Amazing',
          content: 'The most comfortable mattress I\'ve ever slept on. Wake up with no more back pains. So amazing, I can\t even feel my boyfriend get up in the middle of the night. Worth every penny!',
          reviewer: 'Haylee K.'
        }],
        benefits: [
          {
            heading: 'Luxury Comfort',
            className: 'comfort',
            content: 'Plush layers created with the highest quality materials deliver unmatched comfort and the most luxurious sleep experience.'
          },
          {
            heading: 'Ergonomic Support',
            className: 'support',
            content: 'Highly resilient foam combined with hundreds of individually wrapped coils adapt to your body, ensuring proper spine alignment and support for more restful sleep.'
          },
          {
            heading: 'Cooler Sleep',
            className: 'breathable',
            content: 'Lulls cooling gel technology provides a cooler sleep surface and individually wrapped coils promote airflow to help regulate your body temperature.'
          }
        ],
        dimensions: [
          {
            catId: 28,
            dimensions: [
              { size: 'TW', w: '38"', l: '75"', h: '13"', totalHeight: '', weight: '60 lbs.' },
              { size: 'TX', w: '38"', l: '80"', h: '13"', totalHeight: '', weight: '62.5 lbs.' },
              { size: 'FL', w: '54"', l: '75"', h: '13"', totalHeight: '', weight: '85.5 lbs.' },
              { size: 'QU', w: '60"', l: '80"', h: '13"', totalHeight: '', weight: '102 lbs.' },
              { size: 'KG', w: '76"', l: '80"', h: '13"', totalHeight: '', weight: '136 lbs.' },
              { size: 'CK', w: '72"', l: '84"', h: '13"', totalHeight: '', weight: '135 lbs.' }
            ]
          }
        ],
        specs: [
          {
            heading: '',
            details: [
              {
                item: 'Construction',
                details: 'Multi-layer foam and supportive coil technology',
                classes: 'construction col-xs-12'
              },
              {
                item: 'Shipping Info',
                details: 'FedEx Ground',
                classes: 'shipping col-xs-5'
              },
              {
                item: 'Shipping Costs',
                details: 'Free Shipping &amp; Returns',
                classes: 'shipping-costs col-xs-7'
              },
              {
                item: 'Warranty',
                details: 'Lifetime',
                classes: 'warranty col-xs-6'
              }
            ]
          }
        ]
      }]
    %}
  {% endfor %}
{% endif %}

{% set originalPremium = [] %}
{% if cart.upsells.originalPremium.length %}
  {% for item in cart.upsells.originalPremium %}	
    {% set originalPremium = [{
        sku: item.sku,
        quantity: 1,
        size: item.name,
        catId: 51,
        colorSelection: false,
        showStarRating: false,
        avgReviews: avgReviews51,
        totalReviews: totalReviews51,
        subtitle: 'A luxurious combination of comfort, support, and cooling technology',
        price: item.price,
        discountPrice: item.discountPrice,
        gallerySlides: 5,
        details: [{
          tagline: 'Multi-layer foam combined with supportive coil technology creates the ultimate sleep experience.',
          bullets: [
            { bullet: 'Free Shipping and Free Returns' },
            { bullet: '365 Night Trial' },
            { bullet: '1-Year Warranty' }
          ]
        }],
        review: [{
          starTotal: 5,
          title: 'Amazing',
          content: 'The most comfortable mattress I\'ve ever slept on. Wake up with no more back pains. So amazing, I can\t even feel my boyfriend get up in the middle of the night. Worth every penny!',
          reviewer: 'Haylee K.'
        }],
        benefits: [
          {
            heading: 'Luxury Comfort',
            className: 'comfort',
            content: 'Plush layers created with the highest quality materials deliver unmatched comfort and the most luxurious sleep experience.'
          },
          {
            heading: 'Ergonomic Support',
            className: 'support',
            content: 'Highly resilient foam combined with hundreds of individually wrapped coils adapt to your body, ensuring proper spine alignment and support for more restful sleep.'
          },
          {
            heading: 'Cooler Sleep',
            className: 'breathable',
            content: 'Lulls cooling gel technology provides a cooler sleep surface and individually wrapped coils promote airflow to help regulate your body temperature.'
          }
        ],
        dimensions: [
          {
            catId: 51,
            dimensions: [
              { size: 'TW', w: '38"', l: '75"', h: '13"', totalHeight: '', weight: '60 lbs.' },
              { size: 'TX', w: '38"', l: '80"', h: '13"', totalHeight: '', weight: '62.5 lbs.' },
              { size: 'FL', w: '54"', l: '75"', h: '13"', totalHeight: '', weight: '85.5 lbs.' },
              { size: 'QU', w: '60"', l: '80"', h: '13"', totalHeight: '', weight: '102 lbs.' },
              { size: 'KG', w: '76"', l: '80"', h: '13"', totalHeight: '', weight: '136 lbs.' },
              { size: 'CK', w: '72"', l: '84"', h: '13"', totalHeight: '', weight: '135 lbs.' }
            ]
          }
        ],
        specs: [
          {
            heading: '',
            details: [
              {
                item: 'Construction',
                details: 'Multi-layer foam and supportive coil technology',
                classes: 'construction col-xs-12'
              },
              {
                item: 'Shipping Info',
                details: 'FedEx Ground',
                classes: 'shipping col-xs-5'
              },
              {
                item: 'Shipping Costs',
                details: 'Free Shipping &amp; Returns',
                classes: 'shipping-costs col-xs-7'
              },
              {
                item: 'Warranty',
                details: 'Lifetime',
                classes: 'warranty col-xs-6'
              }
            ]
          }
        ]
      }]
    %}
  {% endfor %}
{% endif %}

{# Addons #}
{% set ppMattressSkus = [] %}
{% set ppLuxeHybridSkus = [] %}
{% if state.cart.summary.state !== 'WY' %}
  {%- set ppMattress = [{
    catId: 29,
    subtitle: 'Coverage from accidents, stains, tears, rips and more',
    gscModal: true,
    gscModalId: 50609,
    parentCatId: 1
  }]%}

  {%- set ppLuxeHybrid = [{
    catId: 45,
    subtitle: 'Coverage from accidents, stains, tears, rips and more',
    gscModal: true,
    gscModalId: 50609,
    parentCatId: 28
  }]%}

  {% if cart.upsells.ppMattress.length %}
    {% for item in cart.upsells.ppMattress %}	
      {% set sku = (ppMattressSkus.push(item.sku), ppMattressSkus) %}
    {% endfor %}
  {% endif %}

  {% if cart.upsells.ppLuxeHybrid.length %}
    {% for item in cart.upsells.ppLuxeHybrid %}	
      {% set sku = (ppLuxeHybridSkus.push(item.sku), ppLuxeHybridSkus) %}
    {% endfor %}
  {% endif %}
{% endif %}